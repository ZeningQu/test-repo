!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-dataflow"),require("vega-scenegraph"),require("vega-util"),require("d3-array"),require("vega-parser"),require("vega-runtime")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scenegraph","vega-util","d3-array","vega-parser","vega-runtime"],n):n(e.vega=e.vega||{},e.vega,e.vega,e.vega,e.d3,e.vega,e.vega)}(this,function(e,n,t,r,i,a,o){"use strict";function u(e){n.Transform.call(this,null,e)}function s(e,n,t){return n(e.bounds.clear(),e,t)}function d(e){n.Transform.call(this,0,e)}function l(e){var n=e._signals[me];return n||(e._signals[me]=n=e.add(0)),n}function c(e){n.Transform.call(this,null,e)}function h(e){var n=e.groups,t=e.parent;return n&&1===n.size?n.get(Object.keys(n.object)[0]):n&&t?n.lookup(t):null}function f(e){n.Transform.call(this,null,e)}function g(e,n){return!(e.x2-1<n.x1||e.x1+1>n.x2||e.y2-1<n.y1||e.y1+1>n.y2)}function m(e){for(var n,t=1,r=e.length,i=e[0].bounds;t<r;i=n,++t)if(g(i,n=e[t].bounds))return!0}function v(e){var n=e.bounds;return n.width()>1&&n.height()>1}function p(e){n.Transform.call(this,null,e)}function y(e){for(var n,t,r=e.items,i=r.length,a=0,o={marks:[],rowheaders:[],rowfooters:[],colheaders:[],colfooters:[],rowtitle:null,coltitle:null};a<i;++a)if(n=r[a],t=n.items,"group"===n.marktype)switch(n.role){case pe:case ye:break;case be:b(t,o.rowheaders);break;case _e:b(t,o.rowfooters);break;case xe:b(t,o.colheaders);break;case ke:b(t,o.colfooters);break;case we:o.rowtitle=t[0];break;case Me:o.coltitle=t[0];break;default:b(t,o.marks)}return o}function b(e,n){for(var t=0,r=e.length;t<r;++t)n.push(e[t])}function _(e){return{x1:0,y1:0,x2:e.width||0,y2:e.height||0}}function w(e){var n=e.bounds.clone();return n.empty()?n.set(0,0,0,0):n.translate(-(e.x||0),-(e.y||0))}function x(e,n){return"x1"===n?e.x||0:"y1"===n?e.y||0:"x2"===n?(e.x||0)+(e.width||0):"y2"===n?(e.y||0)+(e.height||0):void 0}function k(e,n){return e.bounds[n]}function M(e,n,t){var i=r.isObject(e)?e[n]:e;return null!=i?i:void 0!==t?t:0}function z(e){return e<0?Math.ceil(-e):0}function T(e,n,r){function i(e,n){return Math.floor(Math.min(e,n))}function a(e,n){return Math.ceil(Math.max(e,n))}var o,u,s,d,l,c,h,f,g,m,v,p,b,T=y(n,r),E=T.marks,L="flush"===r.bounds,D=L?_:w,A=new t.Bounds(0,0,0,0),H=M(r.align,"column"),R=M(r.align,"row"),B=M(r.padding,"column"),O=M(r.padding,"row"),U=r.offset,q=n.columns||r.columns||E.length,V=q<0?1:Math.ceil(E.length/q),W=V*q,j=[],P=[],G=[],I=[],F=E.length;for(u=0;u<q;++u)P[u]=0;for(u=0;u<V;++u)I[u]=0;for(u=0;u<F;++u)l=D(E[u]),d=~~(u/q),h=(s=u%q)?Math.ceil(D(E[u-1]).x2):0,f=d?Math.ceil(D(E[u-q]).y2):0,P[s]=Math.max(P[s],h),I[d]=Math.max(I[d],f),j.push(B+z(l.x1)),G.push(O+z(l.y1)),e.dirty(E[u]);for(u=0;u<F;++u)u%q==0&&(j[u]=0),u<q&&(G[u]=0);if("each"===H)for(s=1;s<q;++s){for(b=0,u=s;u<F;u+=q)b<j[u]&&(b=j[u]);for(u=s;u<F;u+=q)j[u]=b+P[s]}else if("all"===H){for(p=0,s=1;s<q;++s)p<P[s]&&(p=P[s]);for(b=0,u=0;u<F;++u)u%q&&b<j[u]&&(b=j[u]);for(u=0;u<F;++u)u%q&&(j[u]=b+p)}else for(s=1;s<q;++s)for(u=s;u<F;u+=q)j[u]+=P[s];if("each"===R)for(d=1;d<V;++d){for(b=0,o=(u=d*q)+q;u<o;++u)b<G[u]&&(b=G[u]);for(u=d*q;u<o;++u)G[u]=b+I[d]}else if("all"===R){for(p=0,d=1;d<V;++d)p<I[d]&&(p=I[d]);for(b=0,u=q;u<F;++u)b<G[u]&&(b=G[u]);for(u=q;u<F;++u)G[u]=b+p}else for(d=1;d<V;++d)for(o=(u=d*q)+q;u<o;++u)G[u]+=I[d];for(g=0,u=0;u<F;++u)h=(c=E[u]).x||0,c.x=g=j[u]+(u%q?g:0),c.bounds.translate(g-h,0);for(s=0;s<q;++s)for(m=0,u=s;u<F;u+=q)f=(c=E[u]).y||0,c.y=m+=G[u],c.bounds.translate(0,m-f);for(u=0;u<F;++u)E[u].mark.bounds.clear();for(u=0;u<F;++u)c=E[u],e.dirty(c),A.union(c.mark.bounds.union(c.bounds));D=L?x:k,v=M(r.headerBand,"row",null),g=C(e,T.rowheaders,E,q,V,-M(U,"rowHeader"),i,0,D,"x1",0,q,1,v),v=M(r.headerBand,"column",null),m=C(e,T.colheaders,E,q,q,-M(U,"columnHeader"),i,1,D,"y1",0,1,q,v),v=M(r.footerBand,"row",null),C(e,T.rowfooters,E,q,V,M(U,"rowFooter"),a,0,D,"x2",q-1,q,1,v),v=M(r.footerBand,"column",null),C(e,T.colfooters,E,q,q,M(U,"columnFooter"),a,1,D,"y2",W-q,1,q,v),T.rowtitle&&(b=g-M(U,"rowTitle"),v=M(r.titleBand,"row",.5),S(e,T.rowtitle,b,0,A,v)),T.coltitle&&(b=m-M(U,"columnTitle"),v=M(r.titleBand,"column",.5),S(e,T.coltitle,b,1,A,v))}function C(e,n,t,r,i,a,o,u,s,d,l,c,h,f){var g,m,v,p,y,b,_,w,x,k=t.length,M=0,z=0;for(g=l;g<k;g+=c)t[g]&&(M=o(M,s(t[g],d)));if(!n.length)return M;for(n.length>i&&(e.warn("Grid headers exceed limit: "+i),n=n.slice(0,i)),M+=a,m=0,p=n.length;m<p;++m)e.dirty(n[m]),n[m].mark.bounds.clear();for(g=l,m=0,p=n.length;m<p;++m,g+=c){for(y=(b=n[m]).mark.bounds,v=g;null==(_=t[v]);v-=h);u?(w=null==f?_.x:Math.round(_.bounds.x1+f*_.bounds.width()),x=M):(w=M,x=null==f?_.y:Math.round(_.bounds.y1+f*_.bounds.height())),y.union(b.bounds.translate(w-(b.x||0),x-(b.y||0))),b.x=w,b.y=x,e.dirty(b),z=o(z,y[d])}return z}function S(e,n,t,r,i,a){if(n){e.dirty(n);var o=t,u=t;r?o=Math.round(i.x1+a*i.width()):u=Math.round(i.y1+a*i.height()),n.bounds.translate(o-(n.x||0),u-(n.y||0)),n.mark.bounds.clear().union(n.bounds),n.x=o,n.y=u,e.dirty(n)}}function E(e){n.Transform.call(this,null,e)}function L(e,n,r){var i,a,o,u,s,d,l=n.items,c=Math.max(0,n.width||0),h=Math.max(0,n.height||0),f=(new t.Bounds).set(0,0,c,h),g=f.clone(),m=f.clone(),v=f.clone(),p=[];for(s=0,d=l.length;s<d;++s)switch((a=l[s]).role){case He:g.union(u=R(e,a,c,h)),(A(a)?m:v).union(u);break;case Re:i=a;break;case Oe:p.push(a);break;case Be:case Ue:case qe:case Ve:case We:case je:m.union(a.bounds),v.union(a.bounds);break;default:f.union(a.bounds)}if(i&&(g.union(u=B(e,i,g)),(A(i)?m:v).union(u)),p.length)for(o={left:0,right:0,top:0,bottom:0,margin:r.legendMargin||8},s=0,d=p.length;s<d;++s)if(u=O(e,p[s],o,m,v,c,h),r.autosize&&r.autosize.type===ze){var y=p[s].items[0].datum.orient;y===Le||y===De?f.add(u.x1,0).add(u.x2,0):y!==Ee&&y!==Ae||f.add(0,u.y1).add(0,u.y2)}else f.union(u);f.union(m).union(v).union(g),U(e,n,f,r)}function D(e,n,t){return e[n]===t?0:(e[n]=t,1)}function A(e){var n=e.items[0].datum.orient;return n===Le||n===De}function H(e){var n=+e.grid;return[e.ticks?n++:-1,e.labels?n++:-1,n+ +e.domain]}function R(e,n,r,i){var a,o,u=n.items[0],s=u.datum,d=s.orient,l=H(s),c=u.range,h=u.offset,f=u.position,g=u.minExtent,m=u.maxExtent,v=s.title&&u.items[l[2]].items[0],p=u.titlePadding,y=u.bounds,b=0,_=0;switch(Ge.clear().union(y),y.clear(),(a=l[0])>-1&&y.union(u.items[a].bounds),(a=l[1])>-1&&y.union(u.items[a].bounds),d){case Ee:b=f||0,_=-h,o=Math.max(g,Math.min(m,-y.y1)),v&&(v.auto?(o+=p,v.y=-o,o+=v.bounds.height()):y.union(v.bounds)),y.add(0,-o).add(c,0);break;case Le:b=-h,_=f||0,o=Math.max(g,Math.min(m,-y.x1)),v&&(v.auto?(o+=p,v.x=-o,o+=v.bounds.width()):y.union(v.bounds)),y.add(-o,0).add(0,c);break;case De:b=r+h,_=f||0,o=Math.max(g,Math.min(m,y.x2)),v&&(v.auto?(o+=p,v.x=o,o+=v.bounds.width()):y.union(v.bounds)),y.add(0,0).add(o,c);break;case Ae:b=f||0,_=i+h,o=Math.max(g,Math.min(m,y.y2)),v&&(v.auto?(o+=p,v.y=o,o+=v.bounds.height()):y.union(v.bounds)),y.add(0,0).add(c,o);break;default:b=u.x,_=u.y}return t.boundStroke(y.translate(b,_),u),D(u,"x",b+Pe)|D(u,"y",_+Pe)&&(u.bounds=Ge,e.dirty(u),u.bounds=y,e.dirty(u)),u.mark.bounds.clear().union(y)}function B(e,n,t){var r=n.items[0],i=r.datum.orient,a=r.offset,o=r.bounds,u=0,s=0;switch(Ge.clear().union(o),i){case Ee:u=r.x,s=t.y1-a;break;case Le:u=t.x1-a,s=r.y;break;case De:u=t.x2+a,s=r.y;break;case Ae:u=r.x,s=t.y2+a;break;default:u=r.x,s=r.y}return o.translate(u-r.x,s-r.y),D(r,"x",u)|D(r,"y",s)&&(r.bounds=Ge,e.dirty(r),r.bounds=o,e.dirty(r)),n.bounds.clear().union(o)}function O(e,n,r,i,a,o,u){var s,d,l,c=n.items[0],h=c.datum.orient,f=c.offset,g=c.bounds,m=0,v=0;switch(h===Ee||h===Ae?(l=a,m=r[h]):h!==Le&&h!==De||(l=i,v=r[h]),Ge.clear().union(g),g.clear(),c.items.forEach(function(e){g.union(e.bounds)}),s=Math.round(g.width())+2*c.padding-1,d=Math.round(g.height())+2*c.padding-1,h){case Le:m-=s+f-Math.floor(l.x1),r.left+=d+r.margin;break;case De:m+=f+Math.ceil(l.x2),r.right+=d+r.margin;break;case Ee:v-=d+f-Math.floor(l.y1),r.top+=s+r.margin;break;case Ae:v+=f+Math.ceil(l.y2),r.bottom+=s+r.margin;break;case"top-left":m+=f,v+=f;break;case"top-right":m+=o-s-f,v+=f;break;case"bottom-left":m+=f,v+=u-d-f;break;case"bottom-right":m+=o-s-f,v+=u-d-f;break;default:m=c.x,v=c.y}return t.boundStroke(g.set(m,v,m+s,v+d),c),D(c,"x",m)|D(c,"width",s)|D(c,"y",v)|D(c,"height",d)&&(c.bounds=Ge,e.dirty(c),c.bounds=g,e.dirty(c)),c.mark.bounds.clear().union(g)}function U(e,n,t,r){var i=r.autosize||{},a=i.type,o=e._width,u=e._height,s=e.padding();if(!(e._autosize<1)&&a){var d=Math.max(0,n.width||0),l=Math.max(0,Math.ceil(-t.x1)),c=Math.max(0,Math.ceil(t.x2-d)),h=Math.max(0,n.height||0),f=Math.max(0,Math.ceil(-t.y1)),g=Math.max(0,Math.ceil(t.y2-h));i.contains===Se&&(o-=s.left+s.right,u-=s.top+s.bottom),a===Ce?(l=0,f=0,d=o,h=u):a===ze?(d=Math.max(0,o-l-c),h=Math.max(0,u-f-g)):a===Te&&(o=d+l+c,u=h+f+g),e._resizeView(o,u,d,h,[l,f],i.resize)}}function q(e){"undefined"!=typeof document&&document.body&&(document.body.style.cursor=e)}function V(e,n){var t=e._runtime.data;return t.hasOwnProperty(n)||r.error("Unrecognized data set: "+n),t[n]}function W(e,t){n.isChangeSet(t)||r.error("Second argument to changes must be a changeset.");var i=V(this,e);return i.modified=!0,this.pulse(i.input,t)}function j(e){var n=e.padding();return Math.max(0,e._viewWidth+n.left+n.right)}function P(e){var n=e.padding();return Math.max(0,e._viewHeight+n.top+n.bottom)}function G(e){var n=e.padding(),t=e._origin;return[n.left+t[0],n.top+t[1]]}function I(e){var n=G(e);e._renderer.background(e._background),e._renderer.resize(j(e),P(e),n),e._handler.origin(n)}function F(e,n,t){function i(e){var t,r=o;if(e)for(t=n;t;t=t.mark.group)if(t.mark.name===e){r=t;break}return r&&r.mark&&r.mark.interactive?r:{}}function a(e){if(!e)return t;r.isString(e)&&(e=i(e));for(var n=t.slice();e;)n[0]-=e.x||0,n[1]-=e.y||0,e=e.mark&&e.mark.group;return n}var o=n?"group"===n.mark.marktype?n:n.mark.group:null;return{view:r.constant(e),item:r.constant(n||{}),group:i,xy:a,x:function(e){return a(e)[0]},y:function(e){return a(e)[1]}}}function N(e){var n=(e=r.extend({},e)).defaults;return n&&(r.isArray(n.prevent)&&(n.prevent=r.toSet(n.prevent)),r.isArray(n.allow)&&(n.allow=r.toSet(n.allow))),e}function J(e,n){var t=e._eventConfig.defaults,r=t&&t.prevent,i=t&&t.allow;return!1!==r&&!0!==i&&(!0===r||!1===i||(r?r[n]:i?!i[n]:e.preventDefault()))}function K(e){return e.item}function Q(e){var n=e.item.mark.source;return n.source||n}function X(e){return function(n,t){return t.vega.view().changeset().encode(t.item,e)}}function Y(e,n,t,r){var i=Qe("div",{class:Xe});i.appendChild(Qe("span",{class:Ye},t.name||t.signal)),n.appendChild(i);var a=Z;switch(t.input){case"checkbox":a=$;break;case"select":a=ee;break;case"radio":a=ne;break;case"range":a=te}a(e,i,t,r)}function Z(e,n,t,r){var i=Qe("input");for(var a in t)"signal"!==a&&"element"!==a&&i.setAttribute("input"===a?"type":a,t[a]);i.setAttribute("name",t.signal),i.value=r,n.appendChild(i),i.addEventListener("input",function(){e.update(i.value)}),e.elements=[i],e.set=function(e){i.value=e}}function $(e,n,t,r){var i={type:"checkbox",name:t.signal};r&&(i.checked=!0);var a=Qe("input",i);n.appendChild(a),a.addEventListener("change",function(){e.update(a.checked)}),e.elements=[a],e.set=function(e){a.checked=!!e||null}}function ee(e,n,t,r){var i=Qe("select",{name:t.signal});t.options.forEach(function(e){var n={value:e};re(e,r)&&(n.selected=!0),i.appendChild(Qe("option",n,e+""))}),n.appendChild(i),i.addEventListener("change",function(){e.update(t.options[i.selectedIndex])}),e.elements=[i],e.set=function(e){for(var n=0,r=t.options.length;n<r;++n)if(re(t.options[n],e))return void(i.selectedIndex=n)}}function ne(e,n,t,r){var i=Qe("span",{class:Ze});n.appendChild(i),e.elements=t.options.map(function(n){var a=$e+t.signal+"-"+n,o={id:a,type:"radio",name:t.signal,value:n};re(n,r)&&(o.checked=!0);var u=Qe("input",o);return u.addEventListener("change",function(){e.update(n)}),i.appendChild(u),i.appendChild(Qe("label",{for:a},n+"")),u}),e.set=function(n){for(var t=e.elements,r=0,i=t.length;r<i;++r)re(t[r].value,n)&&(t[r].checked=!0)}}function te(e,n,t,r){function a(){l.textContent=d.value,e.update(+d.value)}r=void 0!==r?r:(+t.max+ +t.min)/2;var o=t.min||Math.min(0,+r)||0,u=t.max||Math.max(100,+r)||100,s=t.step||i.tickStep(o,u,100),d=Qe("input",{type:"range",name:t.signal,min:o,max:u,step:s});d.value=r;var l=Qe("label",{},+r);n.appendChild(d),n.appendChild(l),d.addEventListener("input",a),d.addEventListener("change",a),e.elements=[d],e.set=function(e){d.value=e,l.textContent=e}}function re(e,n){return e===n||e+""==n+""}function ie(e,n){if("string"==typeof n){if("undefined"==typeof document)return e.error("DOM document instance not found."),null;n=document.querySelector(n)}return n.innerHTML="",n}function ae(e,n){var t=new Blob([e],{type:n});return window.URL.createObjectURL(t)}function oe(e,n){var t=e.autosize(),r=e.padding();return n-(t&&t.contains===on?r.left+r.right:0)}function ue(e,n){var t=e.autosize(),r=e.padding();return n-(t&&t.contains===on?r.top+r.bottom:0)}function se(e){function n(){e._autosize=e._resize=1}var t=e._signals,r=t.width,i=t.height,a=t.padding;e._resizeWidth=e.add(null,function(t){e._width=t.size,e._viewWidth=oe(e,t.size),n()},{size:r}),e._resizeHeight=e.add(null,function(t){e._height=t.size,e._viewHeight=ue(e,t.size),n()},{size:i});var o=e.add(null,n,{pad:a});e._resizeWidth.rank=r.rank+1,e._resizeHeight.rank=i.rank+1,o.rank=a.rank+1}function de(e,n){return n.modified&&r.isArray(n.input.value)&&e.indexOf("_:vega:_")}function le(e,t){return!("parent"===e||t instanceof n.transforms.Proxy)}function ce(e,i){var a=this;i=i||{},n.Dataflow.call(a),a.loader(i.loader||a._loader),a.logLevel(i.logLevel||0),a._el=null,a._renderType=i.renderer||t.RenderType.Canvas,a._scenegraph=new t.Scenegraph;var o=a._scenegraph.root;a._renderer=null,a._redraw=!0,a._handler=(new t.CanvasHandler).scene(o),a._eventListeners=[],a._preventDefault=!1;var u=an(a,e,i.functions);a._runtime=u,a._signals=u.signals,a._bind=(e.bindings||[]).map(function(e){return{state:null,param:r.extend({},e)}}),u.root&&u.root.set(o),o.source=u.data.root.input,a.pulse(u.data.root.input,a.changeset().insert(o.items)),a._background=u.background||null,a._eventConfig=N(u.eventConfig),a._width=a.width(),a._height=a.height(),a._viewWidth=oe(a,a._width),a._viewHeight=ue(a,a._height),a._origin=[0,0],a._resize=0,a._autosize=1,se(a),Fe(a)}function he(e,n){return e._signals.hasOwnProperty(n)?e._signals[n]:r.error("Unrecognized signal name: "+r.stringValue(n))}var fe=r.inherits(u,n.Transform),ge=new t.Bounds;fe.transform=function(e,n){var r,i=n.dataflow,a=e.mark,o=a.marktype,u=t.Marks[o],d=u.bound,l=a.clip,c=a.bounds;return u.nested?(a.items.length&&i.dirty(a.items[0]),c=s(a,d),a.items.forEach(function(e){e.bounds.clear().union(c)})):"group"===o||e.modified()?(n.visit(n.MOD,function(e){i.dirty(e)}),c.clear(),a.items.forEach(function(e){c.union(s(e,d))})):(r=n.changed(n.REM),n.visit(n.ADD,function(e){c.union(s(e,d))}),n.visit(n.MOD,function(e){r=r||c.alignsWith(e.bounds),i.dirty(e),c.union(s(e,d))}),r&&!l&&(c.clear(),a.items.forEach(function(e){c.union(e.bounds)}))),l&&c.intersect(ge.set(0,0,a.group.width,a.group.height)),n.modifies("bounds")};var me=":vega_identifier:";r.inherits(d,n.Transform).transform=function(e,n){var t=l(n.dataflow),r=t.value,i=e.as;return n.visit(n.ADD,function(e){e[i]||(e[i]=++r)}),t.set(this.value=r),n},r.inherits(c,n.Transform).transform=function(e,n){var r=this.value;r||((r=n.dataflow.scenegraph().mark(e.markdef,h(e),e.index)).group.context=e.context,e.context.group||(e.context.group=r.group),r.source=this,this.value=r);var i="group"===r.marktype?t.GroupItem:t.Item;return n.visit(n.ADD,function(e){i.call(e,r)}),r.items=n.source,n};var ve={parity:function(e){return e.filter(function(e,n){return n%2?e.opacity=0:1})},greedy:function(e){var n;return e.filter(function(e,t){return t&&g(n.bounds,e.bounds)?e.opacity=0:(n=e,1)})}};r.inherits(f,n.Transform).transform=function(e,n){var t=ve[e.method]||ve.parity,i=n.materialize(n.SOURCE).source,a=i;if(a){if("greedy"===e.method&&(a=i=i.filter(v)),a.length>=3&&m(a)){n=n.reflow(e.modified()).modifies("opacity");do{a=t(a)}while(a.length>=3&&m(a));a.length<3&&!r.peek(i).opacity&&(a.length>1&&(r.peek(a).opacity=0),r.peek(i).opacity=1)}return n}},r.inherits(p,n.Transform).transform=function(e,n){var t=n.dataflow;if(n.visit(n.ALL,function(e){t.dirty(e)}),n.fields&&n.fields.zindex){var r=n.source&&n.source[0];r&&(r.mark.zdirty=!0)}};var pe="axis",ye="legend",be="row-header",_e="row-footer",we="row-title",xe="column-header",ke="column-footer",Me="column-title",ze="fit",Te="pad",Ce="none",Se="padding",Ee="top",Le="left",De="right",Ae="bottom",He="axis",Re="title",Be="frame",Oe="legend",Ue="scope",qe="row-header",Ve="row-footer",We="column-header",je="column-footer",Pe=.5,Ge=new t.Bounds;r.inherits(E,n.Transform).transform=function(e,n){var t=n.dataflow;return e.mark.items.forEach(function(n){e.layout&&T(t,n,e.layout),L(t,n,e)}),n};var Ie={type:"Identifier",metadata:{modifies:!0},params:[{name:"as",type:"string",required:!0}]},Fe=function(e){var n=e._signals.cursor;n||(e._signals.cursor=n=e.add({user:"default",item:null})),e.on(e.events("view","mousemove"),n,function(e,t){var i=n.value,a=i?r.isString(i)?i:i.user:"default",o=t.item&&t.item.cursor||null;return i&&a===i.user&&o==i.item?i:{user:a,item:o}}),e.add(null,function(e){var n=e.cursor,t=this.value;return r.isString(n)||(t=n.item,n=n.user),q(n&&"default"!==n?n:t||n),t},{cursor:n})},Ne=function(e,n,r){var i,a,o,u=e._renderer.scene();return u&&(o=G(e),a=n.changedTouches?n.changedTouches[0]:n,(i=t.point(a,u))[0]-=o[0],i[1]-=o[1]),n.dataflow=e,n.vega=F(e,r,i),n.item=r,n},Je="view",Ke="window",Qe=function(e,n,t){var r=document.createElement(e);for(var i in n)r.setAttribute(i,n[i]);return null!=t&&(r.textContent=t),r},Xe="vega-bind",Ye="vega-bind-name",Ze="vega-bind-radio",$e="vega-option-",en=function(e,n,t){if(n){var i=t.param,a=t.state;return a||(a=t.state={elements:null,active:!1,set:null,update:function(n){a.source=!0,e.signal(i.signal,n).run()}},i.debounce&&(a.update=r.debounce(i.debounce,a.update))),r.isString(n)&&(n=document.querySelector(n)),Y(a,n,i,e.signal(i.signal)),a.active||(e.on(e._signals[i.signal],null,function(){a.source?a.source=!1:a.set(e.signal(i.signal))}),a.active=!0),a}},nn=function(e,n,t,r){return(n=n||new r(e.loader())).initialize(t,j(e),P(e),G(e)).background(e._background)},tn=function(e,n,t,r){var i=(new r).scene(e.scenegraph().root).initialize(t,G(e),e);return n&&(i.handleTooltip=n.handleTooltip,n.handlers().forEach(function(e){i.on(e.type,e.handler)})),i},rn=function(e,n){var r=t.renderModule(n);return r&&r.headless?e.runAsync().then(function(){return nn(e,null,null,r.headless).renderAsync(e._scenegraph.root)}):Promise.reject("Unrecognized renderer type: "+n)},an=function(e,t,r){var i=r||a.functionContext;return o.parse(t,o.context(e,n.transforms,i))},on="padding",un=r.inherits(ce,n.Dataflow);un.run=function(e){if(n.Dataflow.prototype.run.call(this,e),this._redraw||this._resize)try{this.render()}catch(e){this.error(e)}return this},un.render=function(){return this._renderer&&(this._resize&&(this._resize=0,I(this)),this._renderer.render(this._scenegraph.root)),this._redraw=!1,this},un.dirty=function(e){this._redraw=!0,this._renderer&&this._renderer.dirty(e)},un.container=function(){return this._el},un.scenegraph=function(){return this._scenegraph},un.signal=function(e,n,t){var r=he(this,e);return 1===arguments.length?r.value:this.update(r,n,t)},un.background=function(e){return arguments.length?(this._background=e,this._resize=1,this):this._background},un.width=function(e){return arguments.length?this.signal("width",e):this.signal("width")},un.height=function(e){return arguments.length?this.signal("height",e):this.signal("height")},un.padding=function(e){return arguments.length?this.signal("padding",e):this.signal("padding")},un.autosize=function(e){return arguments.length?this.signal("autosize",e):this.signal("autosize")},un.renderer=function(e){return arguments.length?(t.renderModule(e)||r.error("Unrecognized renderer type: "+e),e!==this._renderType&&(this._renderType=e,this._renderer&&(this._renderer=null,this.initialize(this._el))),this):this._renderType},un.loader=function(e){return arguments.length?(e!==this._loader&&(n.Dataflow.prototype.loader.call(this,e),this._renderer&&(this._renderer=null,this.initialize(this._el))),this):this._loader},un.resize=function(){return this._autosize=1,this},un._resizeView=function(e,n,t,r,i,a){this.runAfter(function(o){var u=0;o._autosize=0,o.width()!==t&&(u=1,o.width(t),o._resizeWidth.skip(!0)),o.height()!==r&&(u=1,o.height(r),o._resizeHeight.skip(!0)),o._viewWidth!==e&&(o._resize=1,o._viewWidth=e),o._viewHeight!==n&&(o._resize=1,o._viewHeight=n),o._origin[0]===i[0]&&o._origin[1]===i[1]||(o._resize=1,o._origin=i),u&&o.run("enter"),a&&o.runAfter(function(){o.resize()})})},un.addEventListener=function(e,n){return this._handler.on(e,n),this},un.removeEventListener=function(e,n){return this._handler.off(e,n),this},un.addSignalListener=function(e,n){var t=he(this,e),r=function(){n(e,t.value)};return r.handler=n,this.on(t,null,r),this},un.removeSignalListener=function(e,n){var t=he(this,e)._targets||[],r=t.filter(function(e){var t=e._update;return t&&t.handler===n});return r.length&&t.remove(r[0]),this},un.preventDefault=function(e){return arguments.length?(this._preventDefault=e,this):this._preventDefault},un.tooltipHandler=function(e){var n=this._handler;return arguments.length?(n.handleTooltip=e||t.Handler.prototype.handleTooltip,this):n.handleTooltip},un.events=function(e,t,r){var i,a=this,o=new n.EventStream(r),u=function(n,r){e===Je&&J(a,t)&&n.preventDefault();try{o.receive(Ne(a,n,r))}catch(e){a.error(e)}finally{a.run()}};if(e===Je)return a.addEventListener(t,u),o;if(e===Ke?"undefined"!=typeof window&&(i=[window]):"undefined"!=typeof document&&(i=document.querySelectorAll(e)),!i)return a.warn("Can not resolve event source: "+e),o;for(var s=0,d=i.length;s<d;++s)i[s].addEventListener(t,u);return a._eventListeners.push({type:t,sources:i,handler:u}),o},un.finalize=function(){for(var e,n,t=this._eventListeners,r=t.length;--r>=0;)for(e=(n=t[r]).sources.length;--e>=0;)n.sources[e].removeEventListener(n.type,n.handler)},un.hover=function(e,n){return e=e||"hover",n=[n||"update",e],this.on(this.events("view","mouseover",K),Q,X(e)),this.on(this.events("view","mouseout",K),Q,X(n)),this},un.data=function(e){return V(this,e).values.value},un.change=W,un.insert=function(e,t){return W.call(this,e,n.changeset().insert(t))},un.remove=function(e,t){return W.call(this,e,n.changeset().remove(t))},un.initialize=function(e,n){var r,i,a=this,o=a._renderType,u=t.renderModule(o);return e=a._el=e?ie(a,e):null,u||a.error("Unrecognized renderer type: "+o),r=u.handler||t.CanvasHandler,i=e?u.renderer:u.headless,a._renderer=i?nn(a,a._renderer,e,i):null,a._handler=tn(a,a._handler,e,r),a._redraw=!0,e&&(n=n?ie(a,n):e.appendChild(Qe("div",{class:"vega-bindings"})),a._bind.forEach(function(e){e.param.element&&ie(a,e.param.element)}),a._bind.forEach(function(e){en(a,e.param.element||n,e)})),a},un.toImageURL=function(e){return e!==t.RenderType.Canvas&&e!==t.RenderType.SVG&&e!==t.RenderType.PNG?Promise.reject("Unrecognized image type: "+e):rn(this,e).then(function(n){return e===t.RenderType.SVG?ae(n.svg(),"image/svg+xml"):n.canvas().toDataURL("image/png")})},un.toCanvas=function(){return rn(this,t.RenderType.Canvas).then(function(e){return e.canvas()})},un.toSVG=function(){return rn(this,t.RenderType.SVG).then(function(e){return e.svg()})},un.getState=function(e){return this._runtime.getState(e||{data:de,signals:le,recurse:!0})},un.setState=function(e){var n=this;return n._trigger=!1,n._runtime.setState(e),n.run().runAfter(function(){n._trigger=!0}),this},n.register(Ie,d),n.transform("Bound",u),n.transform("Mark",c),n.transform("Overlap",f),n.transform("Render",p),n.transform("ViewLayout",E),e.View=ce,Object.defineProperty(e,"__esModule",{value:!0})});