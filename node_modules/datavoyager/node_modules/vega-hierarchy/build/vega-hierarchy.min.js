!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-util"),require("d3-collection"),require("d3-hierarchy")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-util","d3-collection","d3-hierarchy"],t):t(e.vega=e.vega||{},e.vega,e.vega,e.d3,e.d3)}(this,function(e,t,r,a,n){"use strict";function i(e){t.Transform.call(this,null,e)}function o(e){return e.values}function d(e){t.Transform.call(this,null,e)}function s(e){t.Transform.call(this,{},e)}function u(e){var r;return e.parent&&(r=e.parent.data)&&null!=t.tupleid(r)&&r}function p(e){t.Transform.call(this,null,e)}function l(e,t,r){for(var a,n=0,i=t.length;n<i;++n)(a=t[n])in r&&e[a](r[a])}function f(e,t,r){for(var a=e.data,n=0,i=t.length-1;n<i;++n)a[r[n]]=e[t[n]];a[r[i]]=e.children?e.children.length:0}function m(e){p.call(this,e)}function y(e){p.call(this,e)}function c(e){p.call(this,e)}function h(e){p.call(this,e)}r.inherits(i,t.Transform).transform=function(e,i){i.source||r.error("Nest transform requires an upstream data source.");var d,s,u,p,l=e.key||t.tupleid;return(!this.value||(p=e.modified())||i.changed())&&(d=r.array(e.keys).reduce(function(e,t){return e.key(t),e},a.nest()).entries(i.source),s=n.hierarchy({values:d},o),u=s.lookup={},s.each(function(e){null!=t.tupleid(e.data)&&(u[l(e.data)]=e)}),this.value=s),i.source.root=this.value,p?i.fork(i.ALL):i},r.inherits(d,t.Transform).transform=function(e,t){t.source||r.error("Stratify transform requires an upstream data source.");var a,i,o=e.modified();return(!this.value||o||t.changed(t.ADD_REM)||t.modified(e.key.fields)||t.modified(e.parentKey.fields))&&(a=n.stratify().id(e.key).parentId(e.parentKey)(t.source),i=a.lookup={},a.each(function(t){i[e.key(t.data)]=t}),this.value=a),t.source.root=this.value,o?t.fork(t.ALL):t},r.inherits(s,t.Transform).transform=function(e,a){function n(e){var t=o[e];t&&(s[e]=1,p.mod.push(t))}a.source&&a.source.root||r.error("TreeLinks transform requires a backing tree data source.");var i=a.source.root.lookup,o=this.value,d=e.key||t.tupleid,s={},p=a.fork();return a.visit(a.REM,function(e){var t=d(e),r=o[t];r&&(delete o[t],p.rem.push(r))}),a.visit(a.ADD,function(e){var r,a=d(e);(r=u(i[a]))&&(p.add.push(o[a]=t.ingest({source:r,target:e})),s[a]=1)}),a.visit(a.MOD,function(e){var t=d(e),r=i[t].children;if(n(t),r)for(var a=0,o=r.length;a<o;++a)s[t=d(r[a].data)]||n(t)}),p};var g={binary:n.treemapBinary,dice:n.treemapDice,slice:n.treemapSlice,slicedice:n.treemapSliceDice,squarify:n.treemapSquarify,resquarify:n.treemapResquarify},v={tidy:n.tree,cluster:n.cluster};r.inherits(p,t.Transform).transform=function(e,t){t.source&&t.source.root||r.error(this.constructor.name+" transform requires a backing tree data source.");var a=this.layout(e.method),n=this.fields,i=t.source.root,o=e.as||n;e.field&&i.sum(e.field),e.sort&&i.sort(e.sort),l(a,this.params,e);try{this.value=a(i)}catch(e){r.error(e)}return i.each(function(e){f(e,n,o)}),t.reflow(e.modified()).modifies(o).modifies("leaf")},r.inherits(m,p),m.prototype.layout=function(e){var t=e||"tidy";if(v.hasOwnProperty(t))return v[t]();r.error("Unrecognized Tree layout method: "+t)},m.prototype.params=["size","nodeSize","separation"],m.prototype.fields=["x","y","depth","children"],r.inherits(y,p),y.prototype.layout=function(){var e=n.treemap();return e.ratio=function(t){var r=e.tile();r.ratio&&e.tile(r.ratio(t))},e.method=function(t){g.hasOwnProperty(t)?e.tile(g[t]):r.error("Unrecognized Treemap layout method: "+t)},e},y.prototype.params=["method","ratio","size","round","padding","paddingInner","paddingOuter","paddingTop","paddingRight","paddingBottom","paddingLeft"],y.prototype.fields=["x0","y0","x1","y1","depth","children"],r.inherits(c,p),c.prototype.layout=n.partition,c.prototype.params=["size","round","padding"],c.prototype.fields=y.prototype.fields,r.inherits(h,p),h.prototype.layout=n.pack,h.prototype.params=["size","padding"],h.prototype.fields=["x","y","r","depth","children"];var b={type:"Nest",metadata:{treesource:!0},params:[{name:"keys",type:"field",array:!0},{name:"key",type:"field"}]},k={type:"Stratify",metadata:{treesource:!0},params:[{name:"key",type:"field",required:!0},{name:"parentKey",type:"field",required:!0}]},q={type:"TreeLinks",metadata:{tree:!0,generates:!0,changes:!0},params:[{name:"key",type:"field"}]},T={type:"Pack",metadata:{tree:!0,modifies:!0},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"padding",type:"number",default:0},{name:"radius",type:"field",default:null},{name:"size",type:"number",array:!0,length:2},{name:"as",type:"string",array:!0,length:3,default:["x","y","r","depth","children"]}]},x={type:"Partition",metadata:{tree:!0,modifies:!0},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"padding",type:"number",default:0},{name:"round",type:"boolean",default:!1},{name:"size",type:"number",array:!0,length:2},{name:"as",type:"string",array:!0,length:4,default:["x0","y0","x1","y1","depth","children"]}]},z={type:"Tree",metadata:{tree:!0,modifies:!0},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"method",type:"enum",default:"tidy",values:["tidy","cluster"]},{name:"size",type:"number",array:!0,length:2},{name:"nodeSize",type:"number",array:!0,length:2},{name:"as",type:"string",array:!0,length:4,default:["x","y","depth","children"]}]},L={type:"Treemap",metadata:{tree:!0,modifies:!0},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"method",type:"enum",default:"squarify",values:["squarify","resquarify","binary","dice","slice","slicedice"]},{name:"padding",type:"number",default:0},{name:"paddingInner",type:"number",default:0},{name:"paddingOuter",type:"number",default:0},{name:"paddingTop",type:"number",default:0},{name:"paddingRight",type:"number",default:0},{name:"paddingBottom",type:"number",default:0},{name:"paddingLeft",type:"number",default:0},{name:"ratio",type:"number",default:1.618033988749895},{name:"round",type:"boolean",default:!1},{name:"size",type:"number",array:!0,length:2},{name:"as",type:"string",array:!0,length:4,default:["x0","y0","x1","y1","depth","children"]}]};t.register(b,i),t.register(k,d),t.register(q,s),t.register(T,h),t.register(x,c),t.register(z,m),t.register(L,y),e.transform=t.transform,e.definition=t.definition,Object.defineProperty(e,"__esModule",{value:!0})});