!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-util"),require("vega-loader"),require("vega-statistics"),require("d3-array")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-loader","vega-statistics","d3-array"],e):e(t.vega=t.vega||{},t.vega,t.vega,t.vega,t.d3)}(this,function(t,e,n,i,r){"use strict";function a(t){var n=t||e.identity,i=[],r={};return i.add=function(t){var e=n(t);return r[e]||(r[e]=1,i.push(t)),i},i.remove=function(t){var e,a=n(t);return r[a]&&(r[a]=0,(e=i.indexOf(t))>=0&&i.splice(e,1)),i},i}function s(t){return t[Tt]}function u(t,e){return t[Tt]=e,t}function o(t){var e=t===Object(t)?t:{data:t};return s(e)?e:u(e,jt++)}function l(t){return f(t,o({}))}function f(t,e){for(var n in t)e[n]=t[n];return e}function h(t,e){return u(e,s(t))}function d(t){return t&&t.constructor===c}function c(){var t=[],n=[],i=[],r=[],a=[],u=!1;return{constructor:c,insert:function(n){for(var i=e.array(n),r=0,a=i.length;r<a;++r)t.push(i[r]);return this},remove:function(t){for(var i=e.isFunction(t)?r:n,a=e.array(t),s=0,u=a.length;s<u;++s)i.push(a[s]);return this},modify:function(t,n,r){var s={field:n,value:e.constant(r)};return e.isFunction(t)?(s.filter=t,a.push(s)):(s.tuple=t,i.push(s)),this},encode:function(t,n){return e.isFunction(t)?a.push({filter:t,field:n}):i.push({tuple:t,field:n}),this},reflow:function(){return u=!0,this},pulse:function(e,l){function f(t,n,i){i?t[n]=i(t):e.encode=n,u||(h[s(t)]=t)}var h,d,c,m,p,v,g;for(d=0,c=t.length;d<c;++d)e.add.push(o(t[d]));for(h={},d=0,c=n.length;d<c;++d)h[s(v=n[d])]=v;for(d=0,c=r.length;d<c;++d)p=r[d],l.forEach(function(t){p(t)&&(h[s(t)]=t)});for(g in h)e.rem.push(h[g]);for(h={},d=0,c=i.length;d<c;++d)f((m=i[d]).tuple,m.field,m.value),e.modifies(m.field);for(d=0,c=a.length;d<c;++d)m=a[d],p=m.filter,l.forEach(function(t){p(t)&&f(t,m.field,m.value)}),e.modifies(m.field);if(u)e.mod=n.length||r.length?l.filter(function(t){return h.hasOwnProperty(s(t))}):l.slice();else for(g in h)e.mod.push(h[g]);return e}}}function m(){Object.defineProperty(this,Wt,{writable:!0,value:{}})}function p(t,e,n,i){this.id=++Kt,this.value=t,this.stamp=-1,this.rank=-1,this.qrank=-1,this.flags=0,e&&(this._update=e),n&&this.parameters(n,i)}function v(t){return function(e){var n=this.flags;return 0===arguments.length?!!(n&t):(this.flags=e?n|t:n&~t,this)}}function g(t,e,n){this.id=++Jt,this.value=null,n&&(this.receive=n),t&&(this._filter=t),e&&(this._apply=e)}function y(t,e,n){return new g(t,e,n)}function _(t,n,i,r,a,s){var u,o,l=e.extend({},s,Ht);e.isFunction(i)||(i=e.constant(i)),void 0===r?u=function(e){t.touch(i(e))}:e.isFunction(r)?(o=new p(null,r,a,!1),u=function(e){var n,r=i(e);o.evaluate(e),d(n=o.value)?t.pulse(r,n,s):t.update(r,n,l)}):u=function(e){t.update(i(e),r,l)},n.apply(u)}function x(t,n,i,r,a,s){var u,o;void 0===r?o=i:(u=e.isFunction(r)?r:e.constant(r),(o=new p(null,r=i?function(t,e){var n=u(t,e);return i.skip()?n:i.skip(!0).value=n}:u,a,!1)).modified(s&&s.force),o.rank=0,i&&(o.skip(!0),o.value=i.value,o.targets().add(i))),n.targets().add(o)}function k(t,e,n){this.dataflow=t,this.stamp=null==e?-1:e,this.add=[],this.rem=[],this.mod=[],this.fields=null,this.encode=n||null}function w(t,e){return t?function(n,i){return t(n,i)&&e(n,i)}:e}function b(t,e){var n={};return t.visit(e,function(t){n[s(t)]=1}),function(t){return n[s(t)]?null:t}}function D(t){var e,n,i=new Promise(function(t,i){e=t,n=i});return i.requests=0,i.done=function(){0==--i.requests&&t.runAfter(function(){t._pending=null;try{t.run(),e(t)}catch(t){n(t)}})},t._pending=i}function O(t,e,n,i){var r,a,s,u,o,l=this,f=0;for(this.dataflow=t,this.stamp=e,this.fields=null,this.encode=i||null,this.pulses=n,s=0,u=n.length;s<u;++s)if((r=n[s]).stamp===e){if(r.fields){a=l.fields||(l.fields={});for(o in r.fields)a[o]=1}r.changed(l.ADD)&&(f|=l.ADD),r.changed(l.REM)&&(f|=l.REM),r.changed(l.MOD)&&(f|=l.MOD)}this.changes=f}function q(t){this.cmp=t,this.nodes=[]}function E(t,e,n,i){var r,a,s;for(r=t[n];n>e&&i(r,a=t[s=n-1>>1])<0;)t[n]=a,n=s;return t[n]=r}function F(t,e,n){for(var i,r=e,a=t.length,s=t[e],u=2*e+1;u<a;)(i=u+1)<a&&n(t[u],t[i])>=0&&(u=i),t[e]=t[u],u=2*(e=u)+1;return t[e]=s,E(t,r,e,n)}function A(){this._log=e.logger(),this.logLevel(e.Error),this._clock=0,this._rank=0,this._loader=n.loader(),this._touched=a(e.id),this._pulses={},this._pulse=null,this._heap=new q(function(t,e){return t.qrank-e.qrank}),this._postrun=[]}function M(t){return function(){return this._log[t].apply(this,arguments)}}function R(t,e){p.call(this,t,null,e)}function S(t,e){var n=t.type;N(n,t),C(n,e)}function N(t,e){return t=t&&t.toLowerCase(),arguments.length>1?(re[t]=e,this):re.hasOwnProperty(t)?re[t]:null}function C(t,e){return arguments.length>1?(ie[t]=e,this):ie.hasOwnProperty(t)?ie[t]:null}function P(t,e){return ae[t](e)}function U(t){return function(n){var i=e.extend({init:"",add:"",rem:"",idx:0},t);return i.out=n||t.name,i}}function L(t,e){return t.idx-e.idx}function z(t,e){function n(t,i){function r(e){t[e]||n(t,t[e]=ae[e]())}return i.req&&i.req.forEach(r),e&&i.str&&i.str.forEach(r),t}var i,r=t.reduce(n,t.reduce(function(t,e){return t[e.name]=e,t},{})),a=[];for(i in r)a.push(r[i]);return a.sort(L)}function I(t,n){var i=n||e.identity,r="var cell = this.cell; this.valid = 0; this.missing = 0;",a="this.cell = cell; this.init();",s="if(v==null){++this.missing; return;} if(v!==v) return; ++this.valid;",u="if(v==null){--this.missing; return;} if(v!==v) return; --this.valid;",o="var cell = this.cell;";return z(t,!0).forEach(function(t){r+=t.init,s+=t.add,u+=t.rem}),t.slice().sort(L).forEach(function(t){o+="t['"+t.out+"']="+t.set+";"}),o+="return t;",a=Function("cell",a),a.prototype.init=Function(r),a.prototype.add=Function("v","t",s),a.prototype.rem=Function("v","t",u),a.prototype.set=Function("t",o),a.prototype.get=i,a.fields=t.map(function(t){return t.out}),a}function T(t){return function(e){for(var n=t.length,i=1,r=String(t[0](e));i<n;++i)r+="|"+t[i](e);return r}}function j(t){return t&&t.length?1===t.length?t[0]:T(t):function(){return""}}function W(t){this._key=t?e.field(t):s,this.reset()}function G(t){R.call(this,null,t),this._adds=[],this._mods=[],this._alen=0,this._mlen=0,this._drop=!0,this._cross=!1,this._dims=[],this._dnames=[],this._measures=[],this._countOnly=!1,this._counts=null,this._prev=null,this._inputs=null,this._outputs=null}function K(t){R.call(this,null,t)}function V(t){R.call(this,[],t)}function B(t){p.call(this,null,J,t)}function J(t){return this.value&&!t.modified()?this.value:e.compare(t.fields,t.orders)}function $(t){R.call(this,null,t)}function H(t,e,n){switch(e){case"upper":t=t.toUpperCase();break;case"lower":t=t.toLowerCase()}return t.match(n)}function Q(t){R.call(this,null,t)}function X(t,e,n,i){for(var r,a,s=[],u={},l=t.length,f=0;f<l;++f)for(u[e]=a=t[f],r=0;r<l;++r)u[n]=t[r],i(u)&&(s.push(o(u)),(u={})[e]=a);return s}function Y(t,n){var i=t[pe];ce.hasOwnProperty(i)||e.error("Unknown distribution function: "+i);var r=ce[i]();for(var a in t)a===ve?r.data((t.from||n()).map(t[a])):a===me?r[a](t[a].map(function(t){return Y(t,n)})):typeof r[a]===pe&&r[a](t[a]);return r}function Z(t){R.call(this,null,t)}function tt(t){return function(){return t.materialize(t.SOURCE).source}}function et(t){R.call(this,[1/0,-1/0],t)}function nt(t,e){p.call(this,t),this.parent=e}function it(t){R.call(this,{},t),this._keys=e.fastmap();var n=this._targets=[];n.active=0,n.forEach=function(t){for(var e=0,i=n.active;e<i;++e)t(n[e],e,n)}}function rt(t){p.call(this,null,at,t)}function at(t){return this.value&&!t.modified()?this.value:e.isArray(t.name)?e.array(t.name).map(function(t){return e.field(t)}):e.field(t.name,t.as)}function st(t){R.call(this,e.fastmap(),t)}function ut(t){R.call(this,{},t)}function ot(t){return t.fields.join("|")}function lt(t){R.call(this,null,t)}function ft(t){R.call(this,[],t)}function ht(t){R.call(this,[],t)}function dt(t){var n,i=t.method||_e.value;if(null!=_e[i])return i===_e.value?(n=void 0!==t.value?t.value:0,function(){return n}):_e[i];e.error("Unrecognized imputation method: "+i)}function ct(t){var e=t.field;return function(t){return t?e(t):NaN}}function mt(t,e,n,i){var r,a,s,u,o,l,f,h,d=[],c=i?i.slice():[],m={},p={};for(c.forEach(function(t,e){m[t]=e+1}),u=0,f=t.length;u<f;++u)l=n(h=t[u]),o=m[l]||(m[l]=c.push(l)),(s=p[a=(r=e?e.map(function(t){return t(h)}):xe)+""])||(s=p[a]=[],d.push(s),s.values=r),s[o-1]=h;return d.domain=c,d}function pt(t){G.call(this,t)}function vt(t){p.call(this,null,gt,t)}function gt(t){return this.value&&!t.modified()?this.value:e.key(t.fields)}function yt(t){R.call(this,{},t)}function _t(t){p.call(this,null,xt,t)}function xt(t){if(this.value&&!t.modified())return this.value;var e,n,i,r=1/0,a=-1/0,s=t.extents;for(e=0,n=s.length;e<n;++e)(i=s[e])[0]<r&&(r=i[0]),i[1]>a&&(a=i[1]);return[r,a]}function kt(t){p.call(this,null,wt,t)}function wt(t){return this.value&&!t.modified()?this.value:t.values.reduce(function(t,e){return t.concat(e)},[])}function bt(t){R.call(this,null,t)}function Dt(t){it.call(this,t)}function Ot(t){R.call(this,null,t)}function qt(t){R.call(this,null,t)}function Et(t){R.call(this,null,t)}function Ft(t){R.call(this,[],t),this.count=0}function At(t){R.call(this,null,t)}function Mt(t){R.call(this,null,t),this.modified(!0)}function Rt(t){R.call(this,e.fastmap(),t)}function St(t){R.call(this,null,t)}function Nt(t,n,i,r){var a=we[t](n,i);return{init:a.init||e.zero,update:function(t,e){e[r]=a.next(t)}}}function Ct(t){function n(t){e.array(e.accessorFields(t)).forEach(function(t){f[t]=1})}var i=this,r=e.array(t.ops),a=e.array(t.fields),s=e.array(t.params),u=e.array(t.as),o=i.outputs=[],l=i.windows=[],f={},h={},d=!0,c=[],m=[];n(t.sort),r.forEach(function(t,i){var r=a[i],f=e.accessorName(r),p=se(t,f,u[i]);if(n(r),o.push(p),we.hasOwnProperty(t))l.push(Nt(t,a[i],s[i],p));else{if(null==r&&"count"!==t&&e.error("Null aggregate field specified."),"count"===t)return void c.push(p);d=!1;var v=h[f];v||((v=h[f]=[]).field=r,m.push(v)),v.push(P(t,p))}}),(c.length||m.length)&&(i.cell=Pt(m,c,d)),i.inputs=Object.keys(f)}function Pt(t,e,n){t=t.map(function(t){return I(t,t.field)});var i={num:0,agg:null,store:!1,count:e};if(!n)for(var r=t.length,a=i.agg=Array(r),s=0;s<r;++s)a[s]=new t[s](i);if(i.store)var u=i.data=new W;return i.add=function(t){if(i.num+=1,!n){u&&u.add(t);for(var e=0;e<r;++e)a[e].add(a[e].get(t),t)}},i.rem=function(t){if(i.num-=1,!n){u&&u.rem(t);for(var e=0;e<r;++e)a[e].rem(a[e].get(t),t)}},i.set=function(t){var r,s;for(u&&u.values(),r=0,s=e.length;r<s;++r)t[e[r]]=i.num;if(!n)for(r=0,s=a.length;r<s;++r)a[r].set(t)},i.init=function(){i.num=0,u&&u.reset();for(var t=0;t<r;++t)a[t].init()},i}function Ut(t){R.call(this,{},t),this._mlen=0,this._mods=[]}function Lt(t,n,i){var a=i.sort,s=a&&!i.ignorePeers,u=i.frame||[null,0],o=t.data(a),l=o.length,f=0,h=s?r.bisector(a):null,d={i0:0,i1:0,p0:0,p1:0,index:0,data:o,compare:a||e.constant(-1)};for(n.init();f<l;++f)zt(d,u,f,l),s&&It(d,h),n.update(d,o[f])}function zt(t,e,n,i){t.p0=t.i0,t.p1=t.i1,t.i0=null==e[0]?0:Math.max(0,n-Math.abs(e[0])),t.i1=null==e[1]?i:Math.min(i,n+Math.abs(e[1])+1),t.index=n}function It(t,e){var n=t.i0,i=t.i1-1,r=t.compare,a=t.data,s=a.length-1;n>0&&!r(a[n],a[n-1])&&(t.i0=e.left(a,a[n])),i<s&&!r(a[i],a[i+1])&&(t.i1=e.right(a,a[i]))}var Tt=Symbol("vega_id"),jt=1,Wt="_:mod:_",Gt=m.prototype;Gt.set=function(t,n,i,r){var a=this,s=a[t],u=a[Wt];return null!=n&&n>=0?(s[n]!==i||r)&&(s[n]=i,u[n+":"+t]=-1,u[t]=-1):(s!==i||r)&&(a[t]=i,u[t]=e.isArray(i)?1+i.length:-1),a},Gt.modified=function(t,n){var i,r=this[Wt];if(!arguments.length){for(i in r)if(r[i])return!0;return!1}if(e.isArray(t)){for(i=0;i<t.length;++i)if(r[t[i]])return!0;return!1}return null!=n&&n>=0?n+1<r[t]||!!r[n+":"+t]:!!r[t]},Gt.clear=function(){return this[Wt]={},this};var Kt=0,Vt=new m,Bt=p.prototype;Bt.targets=function(){return this._targets||(this._targets=a(e.id))},Bt.set=function(t){return this.value!==t?(this.value=t,1):0},Bt.skip=v(1),Bt.modified=v(2),Bt.parameters=function(t,n){function i(t,e,i){i instanceof p?(i!==o&&(n&&i.targets().add(o),h.push(i)),f.push({op:i,name:t,index:e})):l.set(t,e,i)}n=!1!==n;var r,a,s,u,o=this,l=o._argval=o._argval||new m,f=o._argops=o._argops||[],h=[];for(r in t)if(a=t[r],"pulse"===r)e.array(a).forEach(function(t){t instanceof p?t!==o&&(t.targets().add(o),h.push(t)):e.error("Pulse parameters must be operator instances.")}),o.source=a;else if(e.isArray(a))for(l.set(r,-1,Array(s=a.length)),u=0;u<s;++u)i(r,u,a[u]);else i(r,-1,a);return this.marshall().clear(),h},Bt.marshall=function(t){var e,n,i,r,a,s=this._argval||Vt,u=this._argops;if(u&&(i=u.length))for(n=0;n<i;++n)a=(r=(e=u[n]).op).modified()&&r.stamp===t,s.set(e.name,e.index,r.value,a);return s},Bt.evaluate=function(t){if(this._update){var e=this.marshall(t.stamp),n=this._update(e,t);if(e.clear(),n!==this.value)this.value=n;else if(!this.modified())return t.StopPropagation}},Bt.run=function(t){if(t.stamp<=this.stamp)return t.StopPropagation;var e;return this.skip()?(this.skip(!1),e=0):e=this.evaluate(t),this.stamp=t.stamp,this.pulse=e,e||t};var Jt=0,$t=g.prototype;$t._filter=e.truthy,$t._apply=e.identity,$t.targets=function(){return this._targets||(this._targets=a(e.id))},$t.consume=function(t){return arguments.length?(this._consume=!!t,this):!!this._consume},$t.receive=function(t){if(this._filter(t)){for(var e=this.value=this._apply(t),n=this._targets,i=n?n.length:0,r=0;r<i;++r)n[r].receive(e);this._consume&&(t.preventDefault(),t.stopPropagation())}},$t.filter=function(t){var e=y(t);return this.targets().add(e),e},$t.apply=function(t){var e=y(null,t);return this.targets().add(e),e},$t.merge=function(){var t=y();this.targets().add(t);for(var e=0,n=arguments.length;e<n;++e)arguments[e].targets().add(t);return t},$t.throttle=function(t){var e=-1;return this.filter(function(){var n=Date.now();return n-e>t?(e=n,1):0})},$t.debounce=function(t){var n=y();return this.targets().add(y(null,null,e.debounce(t,function(t){var e=t.dataflow;n.receive(t),e&&e.run&&e.run()}))),n},$t.between=function(t,e){var n=!1;return t.targets().add(y(null,null,function(){n=!0})),e.targets().add(y(null,null,function(){n=!1})),this.filter(function(){return n})};var Ht={skip:!0},Qt={},Xt=k.prototype;Xt.StopPropagation=Qt,Xt.ADD=1,Xt.REM=2,Xt.MOD=4,Xt.ADD_REM=3,Xt.ADD_MOD=5,Xt.ALL=7,Xt.REFLOW=8,Xt.SOURCE=16,Xt.NO_SOURCE=32,Xt.NO_FIELDS=64,Xt.fork=function(t){return new k(this.dataflow).init(this,t)},Xt.addAll=function(){var t=this;return this.source&&this.source.length!==this.add.length?(t=new k(this.dataflow).init(this),t.add=t.source,t):t},Xt.init=function(t,e){var n=this;return n.stamp=t.stamp,n.encode=t.encode,!t.fields||64&e||(n.fields=t.fields),1&e?(n.addF=t.addF,n.add=t.add):(n.addF=null,n.add=[]),2&e?(n.remF=t.remF,n.rem=t.rem):(n.remF=null,n.rem=[]),4&e?(n.modF=t.modF,n.mod=t.mod):(n.modF=null,n.mod=[]),32&e?(n.srcF=null,n.source=null):(n.srcF=t.srcF,n.source=t.source),n},Xt.runAfter=function(t){this.dataflow.runAfter(t)},Xt.changed=function(t){var e=t||7;return 1&e&&this.add.length||2&e&&this.rem.length||4&e&&this.mod.length},Xt.reflow=function(t){if(t)return this.fork(7).reflow();var e=this.add.length,n=this.source&&this.source.length;return n&&n!==e&&(this.mod=this.source,e&&this.filter(4,b(this,1))),this},Xt.modifies=function(t){var n=e.array(t),i=this.fields||(this.fields={});return n.forEach(function(t){i[t]=!0}),this},Xt.modified=function(t){var n=this.fields;return!(!this.mod.length||!n)&&(arguments.length?e.isArray(t)?t.some(function(t){return n[t]}):n[t]:!!n)},Xt.filter=function(t,e){var n=this;return 1&t&&(n.addF=w(n.addF,e)),2&t&&(n.remF=w(n.remF,e)),4&t&&(n.modF=w(n.modF,e)),16&t&&(n.srcF=w(n.srcF,e)),n},Xt.materialize=function(t){var e=this;return 1&(t=t||7)&&e.addF&&(e.add=e.add.filter(e.addF),e.addF=null),2&t&&e.remF&&(e.rem=e.rem.filter(e.remF),e.remF=null),4&t&&e.modF&&(e.mod=e.mod.filter(e.modF),e.modF=null),16&t&&e.srcF&&(e.source=e.source.filter(e.srcF),e.srcF=null),e},Xt.visit=function(t,n){var i,r,a=n;return 16&t?(e.visitArray(this.source,this.srcF,a),this):(1&t&&e.visitArray(this.add,this.addF,a),2&t&&e.visitArray(this.rem,this.remF,a),4&t&&e.visitArray(this.mod,this.modF,a),8&t&&(i=this.source)&&((r=this.add.length+this.mod.length)===i.length||(r?e.visitArray(i,b(this,5),a):e.visitArray(i,this.srcF,a))),this)};var Yt={skip:!1,force:!1},Zt=e.inherits(O,k);Zt.fork=function(){return arguments.length&&arguments[0]&k.prototype.ALL&&e.error("MultiPulse fork does not support tuple change sets."),new k(this.dataflow).init(this,0)},Zt.changed=function(t){return this.changes&t},Zt.modified=function(t){var n=this,i=n.fields;return i&&n.changes&n.MOD?e.isArray(t)?t.some(function(t){return i[t]}):i[t]:0},Zt.filter=function(){e.error("MultiPulse does not support filtering.")},Zt.materialize=function(){e.error("MultiPulse does not support materialization.")},Zt.visit=function(t,e){var n=this,i=n.pulses,r=i.length,a=0;if(t&n.SOURCE)for(;a<r;++a)i[a].visit(t,e);else for(;a<r;++a)i[a].stamp===n.stamp&&i[a].visit(t,e);return n};var te=q.prototype;te.size=function(){return this.nodes.length},te.clear=function(){return this.nodes=[],this},te.peek=function(){return this.nodes[0]},te.push=function(t){var e=this.nodes;return e.push(t),E(e,0,e.length-1,this.cmp)},te.pop=function(){var t,e=this.nodes,n=e.pop();return e.length?(t=e[0],e[0]=n,F(e,0,this.cmp)):t=n,t},te.replace=function(t){var e=this.nodes,n=e[0];return e[0]=t,F(e,0,this.cmp),n},te.pushpop=function(t){var e=this.nodes,n=e[0];return e.length&&this.cmp(n,t)<0&&(e[0]=t,t=n,F(e,0,this.cmp)),t};var ee=A.prototype;ee.stamp=function(){return this._clock},ee.loader=function(t){return arguments.length?(this._loader=t,this):this._loader},ee.cleanThreshold=1e4,ee.add=function(t,n,i,r){var a,s=1;return t instanceof p?a=t:t&&t.prototype instanceof p?a=new t:e.isFunction(t)?a=new p(null,t):(s=0,a=new p(t,n)),this.rank(a),s&&(r=i,i=n),i&&this.connect(a,a.parameters(i,r)),this.touch(a),a},ee.connect=function(t,e){var n,i,r=t.rank;for(n=0,i=e.length;n<i;++n)if(r<e[n].rank)return void this.rerank(t)},ee.rank=function(t){t.rank=++this._rank},ee.rerank=function(t){for(var e,n,i,r=[t];r.length;)if(this.rank(e=r.pop()),n=e._targets)for(i=n.length;--i>=0;)r.push(e=n[i]),e===t&&this.error("Cycle detected in dataflow graph.")},ee.pulse=function(t,e,n){this.touch(t,n||Yt);var i=new k(this,this._clock+(this._pulse?0:1)),r=t.pulse&&t.pulse.source||[];return i.target=t,this._pulses[t.id]=e.pulse(i,r),this},ee.touch=function(t,e){var n=e||Yt;return this._pulse?this._enqueue(t):this._touched.add(t),n.skip&&t.skip(!0),this},ee.update=function(t,e,n){var i=n||Yt;return(t.set(e)||i.force)&&this.touch(t,i),this},ee.changeset=c,ee.ingest=function(t,e,i){return this.pulse(t,this.changeset().insert(n.read(e,i)))},ee.request=function(t,e,n){var i=this,r=i._pending||D(i);r.requests+=1,i.loader().load(e,{context:"dataflow"}).then(function(e){i.ingest(t,e,n)},function(t){i.error("Loading failed",e,t)}).catch(function(t){i.error("Data ingestion failed",e,t)}).then(r.done,r.done)},ee.events=function(t,n,i,r){for(var a,s=this,u=y(i,r),o=0,l=(a="string"==typeof t&&"undefined"!=typeof document?document.querySelectorAll(t):e.array(t)).length;o<l;++o)a[o].addEventListener(n,function(t){t.dataflow=s;try{u.receive(t)}catch(t){s.error(t)}finally{s.run()}});return u},ee.on=function(t,e,n,i,r){return(t instanceof p?x:_)(this,t,e,n,i,r),this},ee.run=function(t){var n,i,r,s,u=this,o=0,l=u.logLevel();if(u._pending)return u.info("Awaiting requests, delaying dataflow run."),0;if(u._pulse)return u.error("Dataflow invoked recursively. Use the runAfter method to queue invocation."),0;if(!u._touched.length)return u.info("Dataflow invoked, but nothing to do."),0;u._pulse=new k(u,++u._clock,t),l>=e.Info&&(r=Date.now(),u.debug("-- START PROPAGATION ("+u._clock+") -----")),u._touched.forEach(function(t){u._enqueue(t,!0)}),u._touched=a(e.id);try{for(;u._heap.size()>0;)(n=u._heap.pop()).rank===n.qrank?(i=n.run(u._getPulse(n,t)),l>=e.Debug&&u.debug(n.id,i===Qt?"STOP":i,n),i!==Qt&&(u._pulse=i,n._targets&&n._targets.forEach(function(t){u._enqueue(t)})),++o):u._enqueue(n,!0)}catch(t){s=t}if(u._pulses={},u._pulse=null,l>=e.Info&&(r=Date.now()-r,u.info("> Pulse "+u._clock+": "+o+" operators; "+r+"ms")),s&&(u._postrun=[],u.error(s)),u._onrun)try{u._onrun(u,o,s)}catch(t){u.error(t)}if(u._postrun.length){var f=u._postrun;u._postrun=[],f.forEach(function(t){try{t(u)}catch(t){u.error(t)}})}return o},ee.runAsync=function(){return this._pending||Promise.resolve(this.run())},ee.runAfter=function(t,e){if(this._pulse||e)this._postrun.push(t);else try{t(this)}catch(t){this.error(t)}},ee._enqueue=function(t,e){var n=!this._pulses[t.id];n&&(this._pulses[t.id]=this._pulse),(n||e)&&(t.qrank=t.rank,this._heap.push(t))},ee._getPulse=function(t,n){var i,r=t.source,a=this._clock;return r&&e.isArray(r)?(i=r.map(function(t){return t.pulse}),new O(this,a,i,n)):(r=r&&r.pulse,i=this._pulses[t.id],r&&r!==Qt&&(r.stamp===a&&i.target!==t?i=r:i.source=r.source),i)},ee.error=M("error"),ee.warn=M("warn"),ee.info=M("info"),ee.debug=M("debug"),ee.logLevel=M("level");var ne=e.inherits(R,p);ne.run=function(t){if(t.stamp<=this.stamp)return t.StopPropagation;var e;return this.skip()?this.skip(!1):e=this.evaluate(t),(e=e||t)!==t.StopPropagation&&(this.pulse=e),this.stamp=t.stamp,e},ne.evaluate=function(t){var e=this.marshall(t.stamp),n=this.transform(e,t);return e.clear(),n},ne.transform=function(){};var ie={},re={},ae={values:U({name:"values",init:"cell.store = true;",set:"cell.data.values()",idx:-1}),count:U({name:"count",set:"cell.num"}),missing:U({name:"missing",set:"this.missing"}),valid:U({name:"valid",set:"this.valid"}),sum:U({name:"sum",init:"this.sum = 0;",add:"this.sum += v;",rem:"this.sum -= v;",set:"this.sum"}),mean:U({name:"mean",init:"this.mean = 0;",add:"var d = v - this.mean; this.mean += d / this.valid;",rem:"var d = v - this.mean; this.mean -= this.valid ? d / this.valid : this.mean;",set:"this.mean"}),average:U({name:"average",set:"this.mean",req:["mean"],idx:1}),variance:U({name:"variance",init:"this.dev = 0;",add:"this.dev += d * (v - this.mean);",rem:"this.dev -= d * (v - this.mean);",set:"this.valid > 1 ? this.dev / (this.valid-1) : 0",req:["mean"],idx:1}),variancep:U({name:"variancep",set:"this.valid > 1 ? this.dev / this.valid : 0",req:["variance"],idx:2}),stdev:U({name:"stdev",set:"this.valid > 1 ? Math.sqrt(this.dev / (this.valid-1)) : 0",req:["variance"],idx:2}),stdevp:U({name:"stdevp",set:"this.valid > 1 ? Math.sqrt(this.dev / this.valid) : 0",req:["variance"],idx:2}),stderr:U({name:"stderr",set:"this.valid > 1 ? Math.sqrt(this.dev / (this.valid * (this.valid-1))) : 0",req:["variance"],idx:2}),distinct:U({name:"distinct",set:"cell.data.distinct(this.get)",req:["values"],idx:3}),ci0:U({name:"ci0",set:"cell.data.ci0(this.get)",req:["values"],idx:3}),ci1:U({name:"ci1",set:"cell.data.ci1(this.get)",req:["values"],idx:3}),median:U({name:"median",set:"cell.data.q2(this.get)",req:["values"],idx:3}),q1:U({name:"q1",set:"cell.data.q1(this.get)",req:["values"],idx:3}),q3:U({name:"q3",set:"cell.data.q3(this.get)",req:["values"],idx:3}),argmin:U({name:"argmin",init:"this.argmin = null;",add:"if (v < this.min) this.argmin = t;",rem:"if (v <= this.min) this.argmin = null;",set:"this.argmin || cell.data.argmin(this.get)",req:["min"],str:["values"],idx:3}),argmax:U({name:"argmax",init:"this.argmax = null;",add:"if (v > this.max) this.argmax = t;",rem:"if (v >= this.max) this.argmax = null;",set:"this.argmax || cell.data.argmax(this.get)",req:["max"],str:["values"],idx:3}),min:U({name:"min",init:"this.min = null;",add:"if (v < this.min || this.min === null) this.min = v;",rem:"if (v <= this.min) this.min = NaN;",set:"this.min = (isNaN(this.min) ? cell.data.min(this.get) : this.min)",str:["values"],idx:4}),max:U({name:"max",init:"this.max = null;",add:"if (v > this.max || this.max === null) this.max = v;",rem:"if (v >= this.max) this.max = NaN;",set:"this.max = (isNaN(this.max) ? cell.data.max(this.get) : this.max)",str:["values"],idx:4})},se=function(t,e,n){return n||t+(e?"_"+e:"")},ue=W.prototype;ue.reset=function(){this._add=[],this._rem=[],this._ext=null,this._get=null,this._q=null},ue.add=function(t){this._add.push(t)},ue.rem=function(t){this._rem.push(t)},ue.values=function(){if(this._get=null,0===this._rem.length)return this._add;var t,e,n,i=this._add,r=this._rem,a=this._key,s=i.length,u=r.length,o=Array(s-u),l={};for(t=0;t<u;++t)l[a(r[t])]=1;for(t=0,e=0;t<s;++t)l[a(n=i[t])]?l[a(n)]=0:o[e++]=n;return this._rem=[],this._add=o},ue.distinct=function(t){for(var e,n=this.values(),i=n.length,r={},a=0;--i>=0;)e=t(n[i])+"",r.hasOwnProperty(e)||(r[e]=1,++a);return a},ue.extent=function(t){if(this._get!==t||!this._ext){var n=this.values(),i=e.extentIndex(n,t);this._ext=[n[i[0]],n[i[1]]],this._get=t}return this._ext},ue.argmin=function(t){return this.extent(t)[0]||{}},ue.argmax=function(t){return this.extent(t)[1]||{}},ue.min=function(t){var e=this.extent(t)[0];return null!=e?t(e):1/0},ue.max=function(t){var e=this.extent(t)[1];return null!=e?t(e):-1/0},ue.quartile=function(t){return this._get===t&&this._q||(this._q=i.quartiles(this.values(),t),this._get=t),this._q},ue.q1=function(t){return this.quartile(t)[0]},ue.q2=function(t){return this.quartile(t)[1]},ue.q3=function(t){return this.quartile(t)[2]},ue.ci=function(t){return this._get===t&&this._ci||(this._ci=i.bootstrapCI(this.values(),1e3,.05,t),this._get=t),this._ci},ue.ci0=function(t){return this.ci(t)[0]},ue.ci1=function(t){return this.ci(t)[1]};var oe=["values","count","valid","missing","distinct","min","max","argmin","argmax","sum","mean","average","variance","variancep","stdev","stdevp","stderr","median","q1","q3","ci0","ci1"],le=e.inherits(G,R);le.transform=function(t,e){var n,i=this,r=e.fork(e.NO_SOURCE|e.NO_FIELDS);return this.stamp=r.stamp,this.value&&((n=t.modified())||e.modified(this._inputs))?(this._prev=this.value,this.value=n?this.init(t):{},e.visit(e.SOURCE,function(t){i.add(t)})):(this.value=this.value||this.init(t),e.visit(e.REM,function(t){i.rem(t)}),e.visit(e.ADD,function(t){i.add(t)})),r.modifies(this._outputs),i._drop=!1!==t.drop,t.cross&&i._dims.length>1&&(i._drop=!1,this.cross()),i.changes(r)},le.cross=function(){function t(t){var e,n,i,u;for(e in t)for(i=t[e].tuple,n=0;n<s;++n)a[n][u=i[r[n]]]=u}function e(t,u,o){var l,f,h=r[o],d=a[o++];for(l in d)u[h]=d[l],f=t?t+"|"+l:l,o<s?e(f,u,o):i[f]||n.cell(f,u)}var n=this,i=n.value,r=n._dnames,a=r.map(function(){return{}}),s=r.length;t(n._prev),t(i),e("",{},0)},le.init=function(t){function n(t){for(var n,r=e.array(e.accessorFields(t)),s=0,u=r.length;s<u;++s)a[n=r[s]]||(a[n]=1,i.push(n))}var i=this._inputs=[],r=this._outputs=[],a={};this._dims=e.array(t.groupby),this._dnames=this._dims.map(function(t){var i=e.accessorName(t);return n(t),r.push(i),i}),this.cellkey=t.key?t.key:j(this._dims),this._countOnly=!0,this._counts=[],this._measures=[];var s,u,o,l,f,h,d=t.fields||[null],c=t.ops||["count"],m=t.as||[],p=d.length,v={};for(p!==c.length&&e.error("Unmatched number of fields and aggregate ops."),h=0;h<p;++h)s=d[h],u=c[h],null==s&&"count"!==u&&e.error("Null aggregate field specified."),l=e.accessorName(s),f=se(u,l,m[h]),r.push(f),"count"!==u?((o=v[l])||(n(s),(o=v[l]=[]).field=s,this._measures.push(o)),"count"!==u&&(this._countOnly=!1),o.push(P(u,f))):this._counts.push(f);return this._measures=this._measures.map(function(t){return I(t,t.field)}),{}},le.cellkey=j(),le.cell=function(t,e){var n=this.value[t];return n?0===n.num&&this._drop&&n.stamp<this.stamp?(n.stamp=this.stamp,this._adds[this._alen++]=n):n.stamp<this.stamp&&(n.stamp=this.stamp,this._mods[this._mlen++]=n):(n=this.value[t]=this.newcell(t,e),this._adds[this._alen++]=n),n},le.newcell=function(t,e){var n={key:t,num:0,agg:null,tuple:this.newtuple(e,this._prev&&this._prev[t]),stamp:this.stamp,store:!1};if(!this._countOnly){var i,r=this._measures,a=r.length;for(n.agg=Array(a),i=0;i<a;++i)n.agg[i]=new r[i](n)}return n.store&&(n.data=new W),n},le.newtuple=function(t,e){var n,i,r=this._dnames,a=this._dims,s={};for(n=0,i=a.length;n<i;++n)s[r[n]]=a[n](t);return e?h(e.tuple,s):o(s)},le.add=function(t){var e,n,i,r=this.cellkey(t),a=this.cell(r,t);if(a.num+=1,!this._countOnly)for(a.store&&a.data.add(t),n=0,i=(e=a.agg).length;n<i;++n)e[n].add(e[n].get(t),t)},le.rem=function(t){var e,n,i,r=this.cellkey(t),a=this.cell(r,t);if(a.num-=1,!this._countOnly)for(a.store&&a.data.rem(t),n=0,i=(e=a.agg).length;n<i;++n)e[n].rem(e[n].get(t),t)},le.celltuple=function(t){var e,n,i,r=t.tuple,a=this._counts;for(t.store&&t.data.values(),n=0,i=a.length;n<i;++n)r[a[n]]=t.num;if(!this._countOnly)for(n=0,i=(e=t.agg).length;n<i;++n)e[n].set(r);return r},le.changes=function(t){var e,n,i,r,a=this._adds,s=this._mods,u=this._prev,o=this._drop,l=t.add,f=t.rem,h=t.mod;if(u)for(n in u)e=u[n],o&&!e.num||f.push(e.tuple);for(i=0,r=this._alen;i<r;++i)l.push(this.celltuple(a[i])),a[i]=null;for(i=0,r=this._mlen;i<r;++i)(0===(e=s[i]).num&&o?f:h).push(this.celltuple(e)),s[i]=null;return this._alen=this._mlen=0,this._prev=null,t};var fe=e.inherits(K,R);fe.transform=function(t,n){var i,r=this._bins(t),a=r.start,s=r.step,u=t.as||["bin0","bin1"],o=u[0],l=u[1];return i=t.modified()?(n=n.reflow(!0)).SOURCE:n.modified(e.accessorFields(t.field))?n.ADD_MOD:n.ADD,n.visit(i,function(t){var e=r(t);t[o]=e,t[l]=null==e?null:a+s*(1+(e-a)/s)}),n.modifies(u)},fe._bins=function(t){if(this.value&&!t.modified())return this.value;var n,r,a=t.field,s=i.bin(t),u=s.start,o=s.stop,l=s.step;null!=(n=t.anchor)&&(r=n-(u+l*Math.floor((n-u)/l)),u+=r,o+=r);var f=function(t){var e=a(t);return null==e?null:(e=Math.max(u,Math.min(+e,o-l)),u+l*Math.floor((e-u)/l))};return f.start=u,f.stop=o,f.step=l,this.value=e.accessor(f,e.accessorFields(a),t.name||"bin_"+e.accessorName(a))};var he=function(t,n,i){var r=t,a=n||[],s=i||[],u={},o=0;return{add:function(t){s.push(t)},remove:function(t){u[r(t)]=++o},size:function(){return a.length},data:function(t,n){return o&&(a=a.filter(function(t){return!u[r(t)]}),u={},o=0),n&&t&&a.sort(t),s.length&&(a=t?e.merge(t,a,s.sort(t)):a.concat(s),s=[]),a}}};e.inherits(V,R).transform=function(t,e){var n=e.fork(e.ALL),i=he(s,this.value,n.materialize(n.ADD).add),r=t.sort,a=e.changed()||r&&(t.modified("sort")||e.modified(r.fields));return n.visit(n.REM,i.remove),this.modified(a),this.value=n.source=i.data(r,a),n},e.inherits(B,p);var de=e.inherits($,R);de.transform=function(t,e){function n(e){return function(n){for(var i,r=H(u(n),t.case,a)||[],o=0,l=r.length;o<l;++o)s.test(i=r[o])||e(i)}}var i=this._parameterCheck(t,e),r=this._counts,a=this._match,s=this._stop,u=t.field,o=t.as||["text","count"],l=n(function(t){r[t]=1+(r[t]||0)}),f=n(function(t){r[t]-=1});return i?e.visit(e.SOURCE,l):(e.visit(e.ADD,l),e.visit(e.REM,f)),this._finish(e,o)},de._parameterCheck=function(t,e){var n=!1;return!t.modified("stopwords")&&this._stop||(this._stop=new RegExp("^"+(t.stopwords||"")+"$","i"),n=!0),!t.modified("pattern")&&this._match||(this._match=new RegExp(t.pattern||"[\\w']+","g"),n=!0),(t.modified("field")||e.modified(t.field.fields))&&(n=!0),n&&(this._counts={}),n},de._finish=function(t,e){var n,i,r,a=this._counts,s=this._tuples||(this._tuples={}),u=e[0],l=e[1],f=t.fork();for(n in a)i=s[n],r=a[n]||0,!i&&r?(s[n]=i=o({}),i[u]=n,i[l]=r,f.add.push(i)):0===r?(i&&f.rem.push(i),a[n]=null,s[n]=null):i[l]!==r&&(i[l]=r,f.mod.push(i));return f.modifies(e)},e.inherits(Q,R).transform=function(t,n){var i=n.fork(n.NO_SOURCE),r=this.value,a=t.as||["a","b"],s=a[0],u=a[1];return!r||n.changed(n.ADD_REM)||t.modified("as")||t.modified("filter")?(r&&(i.rem=r),i.add=this.value=X(n.source,s,u,t.filter||e.truthy)):i.mod=r,i.source=this.value,i.modifies(a)};var ce={kde:i.randomKDE,mixture:i.randomMixture,normal:i.randomNormal,uniform:i.randomUniform},me="distributions",pe="function",ve="field";e.inherits(Z,R).transform=function(t,n){var i=n.fork(n.NO_SOURCE|n.NO_FIELDS);if(!this.value||n.changed()||t.modified()){var a=Y(t.distribution,tt(n)),s=t.method||"pdf";"pdf"!==s&&"cdf"!==s&&e.error("Invalid density method: "+s),t.extent||a.data||e.error("Missing density extent parameter."),s=a[s];var u=t.as||["value","density"],l=t.extent||r.extent(a.data()),f=(l[1]-l[0])/(t.steps||100),h=r.range(l[0],l[1]+f/2,f).map(function(t){var e={};return e[u[0]]=t,e[u[1]]=s(t),o(e)});this.value&&(i.rem=this.value),this.value=i.add=i.source=h}return i},e.inherits(et,R).transform=function(t,e){var n=this.value,i=t.field,r=n[0],a=n[1],s=e.ADD;(e.changed()||e.modified(i.fields)||t.modified("field"))&&(s=e.SOURCE,r=1/0,a=-1/0),e.visit(s,function(t){var e=i(t);e<r&&(r=e),e>a&&(a=e)}),this.value=[r,a]};var ge=e.inherits(nt,p);ge.connect=function(t){return this.targets().add(t),t.source=this},ge.add=function(t){this.value.add.push(t)},ge.rem=function(t){this.value.rem.push(t)},ge.mod=function(t){this.value.mod.push(t)},ge.init=function(t){this.value.init(t,t.NO_SOURCE)},ge.evaluate=function(){return this.value};var ye=e.inherits(it,R);ye.activate=function(t){this._targets[this._targets.active++]=t},ye.subflow=function(t,e,n,i){var r,a,s=this.value,u=s.hasOwnProperty(t)&&s[t];return u?u.value.stamp<n.stamp&&(u.init(n),this.activate(u)):(a=i||(a=this._group[t])&&a.tuple,u=(r=n.dataflow).add(new nt(n.fork(n.NO_SOURCE),this)).connect(e(r,t,a)),s[t]=u,this.activate(u)),u},ye.transform=function(t,e){function n(t){return r.subflow(t,u,e)}var i=e.dataflow,r=this,a=t.key,u=t.subflow,o=this._keys,l=t.modified("key");return this._group=t.group||{},this._targets.active=0,e.visit(e.REM,function(t){var e=s(t),i=o.get(e);void 0!==i&&(o.delete(e),n(i).rem(t))}),e.visit(e.ADD,function(t){var e=a(t);o.set(s(t),e),n(e).add(t)}),l||e.modified(a.fields)?e.visit(e.MOD,function(t){var e=s(t),i=o.get(e),r=a(t);i===r?n(r).mod(t):(o.set(e,r),n(i).rem(t),n(r).add(t))}):e.changed(e.MOD)&&e.visit(e.MOD,function(t){n(o.get(s(t))).mod(t)}),l&&e.visit(e.REFLOW,function(t){var e=s(t),i=o.get(e),r=a(t);i!==r&&(o.set(e,r),n(i).rem(t),n(r).add(t))}),o.empty>i.cleanThreshold&&i.runAfter(o.clean),e},e.inherits(rt,p),e.inherits(st,R).transform=function(t,e){function n(e){var n=s(e),i=f(e,t),a=r.get(n);i&&a?(r.delete(n),u.push(e)):i||a?h&&i&&!a&&l.push(e):(r.set(n,1),o.push(e))}var i=e.dataflow,r=this.value,a=e.fork(),u=a.add,o=a.rem,l=a.mod,f=t.expr,h=!0;return e.visit(e.REM,function(t){var e=s(t);r.has(e)?r.delete(e):o.push(t)}),e.visit(e.ADD,function(e){f(e,t)?u.push(e):r.set(s(e),1)}),e.visit(e.MOD,n),t.modified()&&(h=!1,e.visit(e.REFLOW,n)),r.empty>i.cleanThreshold&&i.runAfter(r.clean),a},e.inherits(ut,R).transform=function(t,e){function n(t){for(var e,n=r[s(t)]=Array(m),i=0;i<m;++i)(e=n[i]=l(t))[h]=c[i],e[d]=u[i](t),v.add.push(e)}var i,r=this.value,a=t.modified("fields"),u=t.fields,o=t.as||["key","value"],h=o[0],d=o[1],c=u.map(ot),m=u.length,p=e.stamp,v=e.fork(e.NO_SOURCE),g=0,y=0;if(a){for(i in r)v.rem.push.apply(v.rem,r[i]);r=this.value={},e.visit(e.SOURCE,n)}else{for(e.visit(e.ADD,n);g<m;++g)e.modified(u[g].fields)&&(y|=1<<g);y&&e.visit(e.MOD,function(t){for(var e,n=r[s(t)],i=0;i<m;++i)y&1<<i&&((e=f(t,n[i],p))[h]=c[i],e[d]=u[i](t),v.mod.push(e))}),e.visit(e.REM,function(t){var e=s(t);v.rem.push.apply(v.rem,r[e]),r[e]=null})}return v.modifies(o)},e.inherits(lt,R).transform=function(t,e){var n=t.expr,i=t.as,r=t.modified(),a=t.initonly?e.ADD:r?e.SOURCE:e.modified(n.fields)?e.ADD_MOD:e.ADD;return r&&(e=e.materialize().reflow(!0)),t.initonly||e.modifies(i),e.visit(a,function(e){e[i]=n(e,t)})},e.inherits(ft,R).transform=function(t,e){var n,i,r,a=this.value,s=e.fork(e.ALL),u=t.size-a.length,l=t.generator;if(u>0){for(n=[];--u>=0;)n.push(r=o(l(t))),a.push(r);s.add=s.add.length?s.materialize(s.ADD).add.concat(n):n}else i=a.slice(0,-u),s.rem=s.rem.length?s.materialize(s.REM).rem.concat(i):i,a=a.slice(-u);return s.source=this.value=a,s};var _e={value:"value",median:r.median,mean:r.mean,min:r.min,max:r.max},xe=[];e.inherits(ht,R).transform=function(t,n){var i,r,a,s,u,l,f,h,d,c,m=n.fork(n.ALL),p=dt(t),v=ct(t),g=e.accessorName(t.field),y=e.accessorName(t.key),_=(t.groupby||[]).map(e.accessorName),x=mt(n.source,t.groupby,t.key,t.keyvals),k=[],w=this.value,b=x.domain.length;for(u=0,h=x.length;u<h;++u)for(a=(i=x[u]).values,r=NaN,f=0;f<b;++f)if(null==i[f]){for(s=x.domain[f],c={_impute:!0},l=0,d=a.length;l<d;++l)c[_[l]]=a[l];c[y]=s,c[g]=isNaN(r)?r=p(i,v):r,k.push(o(c))}return k.length&&(m.add=m.materialize(m.ADD).add.concat(k)),w.length&&(m.rem=m.materialize(m.REM).rem.concat(w)),this.value=k,m};var ke=e.inherits(pt,G);ke.transform=function(t,n){var i,r=this,a=t.modified();return r.value&&(a||n.modified(r._inputs))?(i=r.value=a?r.init(t):{},n.visit(n.SOURCE,function(t){r.add(t)})):(i=r.value=r.value||this.init(t),n.visit(n.REM,function(t){r.rem(t)}),n.visit(n.ADD,function(t){r.add(t)})),r.changes(),n.visit(n.SOURCE,function(t){e.extend(t,i[r.cellkey(t)].tuple)}),n.reflow(a).modifies(this._outputs)},ke.changes=function(){var t,e,n=this._adds,i=this._mods;for(t=0,e=this._alen;t<e;++t)this.celltuple(n[t]),n[t]=null;for(t=0,e=this._mlen;t<e;++t)this.celltuple(i[t]),i[t]=null;this._alen=this._mlen=0},e.inherits(vt,p),e.inherits(yt,R).transform=function(t,n){var i,r,a=n,s=t.as,u=t.fields,o=t.index,l=t.values,f=null==t.default?null:t.default,h=t.modified(),d=h?n.SOURCE:n.ADD,c=u.length;return l?(r=l.length,c>1&&!s&&e.error('Multi-field lookup requires explicit "as" parameter.'),s&&s.length!==c*r&&e.error('The "as" parameter has too few output field names.'),s=s||l.map(e.accessorName),i=function(t){for(var e,n,i=0,a=0;i<c;++i)if(null==(n=o.get(u[i](t))))for(e=0;e<r;++e,++a)t[s[a]]=f;else for(e=0;e<r;++e,++a)t[s[a]]=l[e](n)}):(s||e.error("Missing output field names."),i=function(t){for(var e,n=0;n<c;++n)e=o.get(u[n](t)),t[s[n]]=null==e?f:e}),h?a=n.reflow(!0):d|=u.some(function(t){return n.modified(t.fields)})?n.MOD:0,n.visit(d,i),a.modifies(s)},e.inherits(_t,p),e.inherits(kt,p),e.inherits(bt,R),bt.prototype.transform=function(t,e){return this.modified(t.modified()),this.value=t,e.fork(e.NO_SOURCE|e.NO_FIELDS)},e.inherits(Dt,it).transform=function(t,n){var i=this,r=t.subflow,a=t.field;return(t.modified("field")||a&&n.modified(e.accessorFields(a)))&&e.error("PreFacet does not support field modification."),this._targets.active=0,n.visit(n.MOD,function(t){var e=i.subflow(s(t),r,n,t);a?a(t).forEach(function(t){e.mod(t)}):e.mod(t)}),n.visit(n.ADD,function(t){var e=i.subflow(s(t),r,n,t);a?a(t).forEach(function(t){e.add(o(t))}):e.add(t)}),n.visit(n.REM,function(t){var e=i.subflow(s(t),r,n,t);a?a(t).forEach(function(t){e.rem(t)}):e.rem(t)}),n},e.inherits(Ot,R).transform=function(t,e){return this.value=t.value,t.modified("value")?e.fork(e.NO_SOURCE|e.NO_FIELDS):e.StopPropagation},e.inherits(qt,R).transform=function(t,n){n.source||e.error("Rank transform requires an upstream data source.");var i,r=t.normalize,a=t.field,s=t.as||"rank",u={},o=-1;return a?(n.visit(n.SOURCE,function(t){var e=a(t);null==u[e]&&(u[e]=++o)}),n.visit(n.SOURCE,r&&--o?function(t){t[s]=u[a(t)]/o}:function(t){t[s]=u[a(t)]})):(o+=n.source.length,i=-1,n.visit(n.SOURCE,r&&o?function(t){t[s]=++i/o}:function(t){t[s]=++i})),n.reflow(t.modified()).modifies(s)},e.inherits(Et,R).transform=function(t,e){var n,i;return this.value?i=this.value:(n=e=e.addAll(),i=this.value={}),t.derive&&(n=e.fork(),e.visit(e.REM,function(t){var e=s(t);n.rem.push(i[e]),i[e]=null}),e.visit(e.ADD,function(t){var e=l(t);i[s(t)]=e,n.add.push(e)}),e.visit(e.MOD,function(t){n.mod.push(f(t,i[s(t)]))})),n},e.inherits(Ft,R).transform=function(t,e){function n(t){var e,n;u.length<a?u.push(t):(n=~~(o*Math.random()))<u.length&&n>=l&&(e=u[n],f[s(e)]&&i.rem.push(e),u[n]=t),++o}var i=e.fork(),r=t.modified("size"),a=t.size,u=this.value,o=this.count,l=0,f=u.reduce(function(t,e){return t[s(e)]=1,t},{});if(e.rem.length&&(e.visit(e.REM,function(t){var e=s(t);f[e]&&(f[e]=-1,i.rem.push(t)),--o}),u=u.filter(function(t){return-1!==f[s(t)]})),(e.rem.length||r)&&u.length<a&&e.source&&(l=o=u.length,e.visit(e.SOURCE,function(t){f[s(t)]||n(t)}),l=-1),r&&u.length>a){for(var h=0,d=u.length-a;h<d;++h)f[s(u[h])]=-1,i.rem.push(u[h]);u=u.slice(d)}return e.mod.length&&e.visit(e.MOD,function(t){f[s(t)]&&i.mod.push(t)}),e.add.length&&e.visit(e.ADD,n),(e.add.length||l<0)&&(i.add=u.filter(function(t){return!f[s(t)]})),this.count=o,this.value=i.source=u,i},e.inherits(At,R).transform=function(t,e){if(!this.value||t.modified()){var n=e.materialize().fork(e.MOD);return n.rem=this.value?e.rem.concat(this.value):e.rem,n.source=this.value=r.range(t.start,t.stop,t.step||1).map(o),n.add=e.add.concat(this.value),n}},e.inherits(Mt,R).transform=function(t,e){return this.value=e.source,e.changed()?e.fork(e.NO_SOURCE|e.NO_FIELDS):e.StopPropagation},e.inherits(Rt,R).transform=function(t,e){function n(t){a.set(r(t),t)}var i=e.dataflow,r=t.field,a=this.value,s=!0;return t.modified("field")||e.modified(r.fields)?(a.clear(),e.visit(e.SOURCE,n)):e.changed()?(e.visit(e.REM,function(t){a.delete(r(t))}),e.visit(e.ADD,n)):s=!1,this.modified(s),a.empty>i.cleanThreshold&&i.runAfter(a.clean),e.fork()},e.inherits(St,R).transform=function(t,e){(!this.value||t.modified("field")||t.modified("sort")||e.changed()||t.sort&&e.modified(t.sort.fields))&&(this.value=(t.sort?e.source.slice().sort(t.sort):e.source).map(t.field))};var we={row_number:function(){return{next:function(t){return t.index+1}}},rank:function(){var t;return{init:function(){t=1},next:function(e){var n=e.index,i=e.data;return n&&e.compare(i[n-1],i[n])?t=n+1:t}}},dense_rank:function(){var t;return{init:function(){t=1},next:function(e){var n=e.index,i=e.data;return n&&e.compare(i[n-1],i[n])?++t:t}}},percent_rank:function(){var t=we.rank(),e=t.next;return{init:t.init,next:function(t){return(e(t)-1)/(t.data.length-1)}}},cume_dist:function(){var t;return{init:function(){t=0},next:function(e){var n=e.index,i=e.data,r=e.compare;if(t<n){for(;n+1<i.length&&!r(i[n],i[n+1]);)++n;t=n}return(1+t)/i.length}}},ntile:function(t,n){(n=+n)>0||e.error("ntile num must be greater than zero.");var i=we.cume_dist(),r=i.next;return{init:i.init,next:function(t){return Math.ceil(n*r(t))}}},lag:function(t,e){return e=+e||1,{next:function(n){var i=n.index-e;return i>=0?t(n.data[i]):null}}},lead:function(t,e){return e=+e||1,{next:function(n){var i=n.index+e,r=n.data;return i<r.length?t(r[i]):null}}},first_value:function(t){return{next:function(e){return t(e.data[e.i0])}}},last_value:function(t){return{next:function(e){return t(e.data[e.i1-1])}}},nth_value:function(t,n){return(n=+n)>0||e.error("nth_value nth must be greater than zero."),{next:function(e){var i=e.i0+(n-1);return i<e.i1?t(e.data[i]):null}}}},be=Object.keys(we),De=Ct.prototype;De.init=function(){this.windows.forEach(function(t){t.init()}),this.cell&&this.cell.init()},De.update=function(t,e){var n,i=this,r=i.cell,a=i.windows,s=t.data,u=a&&a.length;if(r){for(n=t.p0;n<t.i0;++n)r.rem(s[n]);for(n=t.p1;n<t.i1;++n)r.add(s[n]);r.set(e)}for(n=0;n<u;++n)a[n].update(t,e)};var Oe=e.inherits(Ut,R);Oe.transform=function(t,e){function n(t){return a.group(o(t))}var i,r,a=this,s=a.state,u=t.modified();this.stamp=e.stamp,s&&!u||(s=a.state=new Ct(t));var o=j(t.groupby);for(u||e.modified(s.inputs)?(a.value={},e.visit(e.SOURCE,function(t){n(t).add(t)})):(e.visit(e.REM,function(t){n(t).remove(t)}),e.visit(e.ADD,function(t){n(t).add(t)})),i=0,r=a._mlen;i<r;++i)Lt(a._mods[i],s,t);return a._mlen=0,a._mods=[],e.reflow(u).modifies(s.outputs)},Oe.group=function(t){var e=this,n=e.value[t];return n||((n=e.value[t]=he(s)).stamp=-1),n.stamp<e.stamp&&(n.stamp=e.stamp,e._mods[e._mlen++]=n),n};var qe={type:"Aggregate",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"fields",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:oe},{name:"as",type:"string",array:!0},{name:"drop",type:"boolean",default:!0},{name:"cross",type:"boolean",default:!1},{name:"key",type:"field"}]},Ee={type:"Bin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"anchor",type:"number"},{name:"maxbins",type:"number",default:20},{name:"base",type:"number",default:10},{name:"divide",type:"number",array:!0,default:[5,2]},{name:"extent",type:"number",array:!0,length:2,required:!0},{name:"step",type:"number"},{name:"steps",type:"number",array:!0},{name:"minstep",type:"number",default:0},{name:"nice",type:"boolean",default:!0},{name:"name",type:"string"},{name:"as",type:"string",array:!0,length:2,default:["bin0","bin1"]}]},Fe={type:"Collect",metadata:{source:!0},params:[{name:"sort",type:"compare"}]},Ae={type:"CountPattern",metadata:{generates:!0,changes:!0},params:[{name:"field",type:"field",required:!0},{name:"case",type:"enum",values:["upper","lower","mixed"],default:"mixed"},{name:"pattern",type:"string",default:'[\\w"]+'},{name:"stopwords",type:"string",default:""},{name:"as",type:"string",array:!0,length:2,default:["text","count"]}]},Me={type:"Cross",metadata:{source:!0,generates:!0,changes:!0},params:[{name:"filter",type:"expr"},{name:"as",type:"string",array:!0,length:2,default:["a","b"]}]},Re=[{key:{function:"normal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"uniform"},params:[{name:"min",type:"number",default:0},{name:"max",type:"number",default:1}]},{key:{function:"kde"},params:[{name:"field",type:"field",required:!0},{name:"from",type:"data"},{name:"bandwidth",type:"number",default:0}]}],Se={key:{function:"mixture"},params:[{name:"distributions",type:"param",array:!0,params:Re},{name:"weights",type:"number",array:!0}]},Ne={type:"Density",metadata:{generates:!0,source:!0},params:[{name:"extent",type:"number",array:!0,length:2},{name:"steps",type:"number",default:100},{name:"method",type:"string",default:"pdf",values:["pdf","cdf"]},{name:"distribution",type:"param",params:Re.concat(Se)},{name:"as",type:"string",array:!0,default:["value","density"]}]},Ce={type:"Extent",metadata:{},params:[{name:"field",type:"field",required:!0}]},Pe={type:"Filter",metadata:{changes:!0},params:[{name:"expr",type:"expr",required:!0}]},Ue={type:"Fold",metadata:{generates:!0,changes:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0,length:2,default:["key","value"]}]},Le={type:"Formula",metadata:{modifies:!0},params:[{name:"expr",type:"expr",required:!0},{name:"as",type:"string",required:!0},{name:"initonly",type:"boolean"}]},ze={type:"Impute",metadata:{changes:!0},params:[{name:"field",type:"field",required:!0},{name:"key",type:"field",required:!0},{name:"keyvals",array:!0},{name:"groupby",type:"field",array:!0},{name:"method",type:"enum",default:"value",values:["value","mean","median","max","min"]},{name:"value",default:0}]},Ie={type:"JoinAggregate",metadata:{modifies:!0},params:[{name:"groupby",type:"field",array:!0},{name:"fields",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:["count","valid","missing","distinct","sum","mean","average","variance","variancep","stdev","stdevp","stderr","median","q1","q3","ci0","ci1","min","max","argmin","argmax"]},{name:"as",type:"string",array:!0},{name:"key",type:"field"}]},Te={type:"Lookup",metadata:{modifies:!0},params:[{name:"index",type:"index",params:[{name:"from",type:"data",required:!0},{name:"key",type:"field",required:!0}]},{name:"values",type:"field",array:!0},{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0},{name:"default",default:null}]},je={type:"Rank",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"normalize",type:"boolean",default:!1},{name:"as",type:"string",default:"rank"}]},We={type:"Sample",metadata:{source:!0,changes:!0},params:[{name:"size",type:"number",default:1e3}]},Ge={type:"Sequence",metadata:{generates:!0,source:!0},params:[{name:"start",type:"number",required:!0},{name:"stop",type:"number",required:!0},{name:"step",type:"number",default:1}],output:["value"]},Ke={type:"Window",metadata:{modifies:!0},params:[{name:"sort",type:"compare"},{name:"frame",type:"number",array:!0,length:2,default:[null,0]},{name:"frameType",type:"enum",values:["range","rows"],default:"range"},{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:be.concat(oe)},{name:"params",type:"number",array:!0},{name:"fields",type:"field",array:!0},{name:"as",type:"string",array:!0}]};S(qe,G),S(Ee,K),S(Fe,V),S(Ae,$),S(Me,Q),S(Ne,Z),S(Ce,et),S(Pe,st),S(Ue,ut),S(Le,lt),S(ze,ht),S(Ie,pt),S(Te,yt),S(je,qt),S(We,Ft),S(Ge,At),S(Ke,Ut),C("Compare",B),C("Facet",it),C("Field",rt),C("Generate",ft),C("Key",vt),C("MultiExtent",_t),C("MultiValues",kt),C("Params",bt),C("PreFacet",Dt),C("Proxy",Ot),C("Relay",Et),C("Sieve",Mt),C("Subflow",nt),C("TupleIndex",Rt),C("Values",St),t.UniqueList=a,t.changeset=c,t.isChangeSet=d,t.Dataflow=A,t.EventStream=g,t.Parameters=m,t.Pulse=k,t.MultiPulse=O,t.Operator=p,t.Transform=R,t.ingest=o,t.isTuple=function(t){return!(!t||!s(t))},t.replace=h,t.tupleid=s,t.definition=N,t.definitions=re,t.register=S,t.transform=C,t.transforms=ie,Object.defineProperty(t,"__esModule",{value:!0})});