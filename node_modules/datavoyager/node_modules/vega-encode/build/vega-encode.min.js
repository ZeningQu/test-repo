!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-dataflow"),require("vega-util"),require("d3-format"),require("vega-scale"),require("d3-array"),require("d3-interpolate")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-util","d3-format","vega-scale","d3-array","d3-interpolate"],n):n(e.vega=e.vega||{},e.vega,e.vega,e.d3,e.vega,e.d3,e.d3)}(this,function(e,n,t,r,a,i,o){"use strict";function u(e,n){var r=e.range(),a=r[0],i=t.peek(r);return a>i&&(r=i,i=a,a=r),n.filter(function(n){return!((n=e(n))<a||n>i)})}function s(e,n){return e.ticks?e.ticks(n):e.domain()}function f(e,n,t){var r=e.tickFormat?e.tickFormat(n,t):String;return e.type===K?l(r,c(t)):r}function l(e,n){return function(t){return e(t)?n(t):""}}function c(e){var n=r.formatSpecifier(e||",");if(null==n.precision){switch(n.precision=12,n.type){case"%":n.precision-=2;break;case"e":n.precision-=1}return d(r.format(n),r.format(".1f")(1)[1])}return r.format(n)}function d(e,n){return function(t){var r,a,i=e(t),o=i.indexOf(n);if(o<0)return i;for(a=(r=m(i,o))<i.length?i.slice(r):"";--r>o;)if("0"!==i[r]){++r;break}return i.slice(0,r)+a}}function m(e,n){var t,r=e.lastIndexOf("e");if(r>0)return r;for(r=e.length;--r>n;)if((t=e.charCodeAt(r))>=48&&t<=57)return r+1}function p(e){n.Transform.call(this,null,e)}function h(e){n.Transform.call(this,null,e)}function v(){return n.ingest({})}function g(e){return e.exit}function y(e){n.Transform.call(this,null,e)}function M(e,n,t){if(t)return e.domain();var r=ie[e.type];return r?r(e):s(e,n)}function x(e){var n=e.domain();return n.max=n.pop(),n}function S(e,n){return ie[e.type]?A(n):O(n)}function A(e){return function(n,t,r){var a=r[t+1]||r.max||1/0,i=k(n,e),o=k(a,e);return i&&o?i+"–"+o:o?"< "+o:"≥ "+i}}function k(e,n){return isFinite(e)?n(e):null}function O(e){return function(n){return e(n)}}function b(e){n.Transform.call(this,[],e)}function D(e){return e.source.x}function T(e){return e.source.y}function E(e){return e.target.x}function w(e){return e.target.y}function F(e){n.Transform.call(this,{},e)}function R(e,n,t,r){return"M"+e+","+n+"L"+t+","+r}function z(e,n,t,r){var a=t-e,i=r-n,o=Math.sqrt(a*a+i*i)/2;return"M"+e+","+n+"A"+o+","+o+" "+180*Math.atan2(i,a)/Math.PI+" 0 1 "+t+","+r}function C(e,n,t,r){var a=t-e,i=r-n,o=.2*(a+i),u=.2*(i-a);return"M"+e+","+n+"C"+(e+o)+","+(n+u)+" "+(t+u)+","+(r-o)+" "+t+","+r}function q(e){n.Transform.call(this,null,e)}function L(e){n.Transform.call(this,null,e),this.modified(!0)}function _(e,n,t){var r=I(e,n.domainRaw);if(r>-1)return r;var a,i,o=n.domain,u=n.zero||void 0===n.zero&&se[e.type];return o?((u||null!=n.domainMin||null!=n.domainMax||null!=n.domainMid)&&(a=(o=o.slice()).length-1||1,u&&(o[0]>0&&(o[0]=0),o[a]<0&&(o[a]=0)),null!=n.domainMin&&(o[0]=n.domainMin),null!=n.domainMax&&(o[a]=n.domainMax),null!=n.domainMid&&(((i=n.domainMid)<o[0]||i>o[a])&&t.warn("Scale domainMid exceeds domain min or max.",i),o.splice(a,0,i))),e.domain(o),n.nice&&e.nice&&e.nice(!0!==n.nice&&+n.nice||null),o.length):0}function I(e,n){return n?(e.domain(n),n.length):-1}function P(e,n,r){var i=n.round||!1,u=n.range;if(null!=n.rangeStep)u=N(e.type,n,r);else if(n.scheme){if(u=U(e.type,n,r),t.isFunction(u))return e.interpolator(u)}else if(u&&e.type===ae)return e.interpolator(o.interpolateRgbBasis(Y(u,n.reverse)));u&&n.interpolate&&e.interpolate?e.interpolate(a.interpolate(n.interpolate,n.interpolateGamma)):t.isFunction(e.round)?e.round(i):t.isFunction(e.rangeRound)&&e.interpolate(i?o.interpolateRound:o.interpolate),u&&e.range(Y(u,n.reverse))}function N(e,n,r){e!==Q&&e!==Z&&t.error("Only band and point scales support rangeStep.");var i=(null!=n.paddingOuter?n.paddingOuter:n.padding)||0,o=e===Z?1:(null!=n.paddingInner?n.paddingInner:n.padding)||0;return[0,n.rangeStep*a.bandSpace(r,o,i)]}function U(e,n,r){var i,o=n.scheme.toLowerCase(),u=a.scheme(o),s=n.schemeExtent;return u||t.error("Unrecognized scheme name: "+n.scheme),r=e===te?r+1:e===re?r-1:e===ee||e===ne?+n.schemeCount||ue:r,e===ae?X(u,s,n.reverse):!s&&(i=a.scheme(o+"-"+r))?i:t.isFunction(u)?j(X(u,s),r):e===$?u:u.slice(0,r)}function X(e,n,r){return t.isFunction(e)&&(n||r)?a.interpolateRange(e,Y(n||[0,1],r)):e}function Y(e,n){return n?e.slice().reverse():e}function j(e,n){for(var t=new Array(n),r=n-1||1,a=0;a<n;++a)t[a]=e(a/r);return t}function G(e){n.Transform.call(this,null,e)}function H(e){n.Transform.call(this,null,e)}function J(e,n,t,r,a){for(var i,o=(n-e.sum)/2,u=e.length,s=0;s<u;++s)(i=e[s])[r]=o,i[a]=o+=Math.abs(t(i))}function V(e,n,t,r,a){for(var i,o=1/e.sum,u=0,s=e.length,f=0,l=0;f<s;++f)(i=e[f])[r]=u,i[a]=u=o*(l+=Math.abs(t(i)))}function B(e,n,t,r,a){for(var i,o,u=0,s=0,f=e.length,l=0;l<f;++l)(i=t(o=e[l]))<0?(o[r]=s,o[a]=s+=i):(o[r]=u,o[a]=u+=i)}function W(e,n,t,r){var a,i,o,u,s,f,l,c,d,m=[];if(null==n)m.push(e.slice());else for(a={},i=0,o=e.length;i<o;++i)s=e[i],(l=a[f=n.map(function(e){return e(s)})])||(a[f]=l=[],m.push(l)),l.push(s);for(f=0,d=0,u=m.length;f<u;++f){for(i=0,c=0,o=(l=m[f]).length;i<o;++i)c+=Math.abs(r(l[i]));l.sum=c,c>d&&(d=c),t&&l.sort(t)}return m.max=d,m}var K="log",Q="band",Z="point",$="ordinal",ee="quantile",ne="quantize",te="threshold",re="bin-ordinal",ae="sequential";t.inherits(p,n.Transform).transform=function(e,t){if(this.value&&!e.modified())return t.StopPropagation;var r=t.fork(t.NO_SOURCE|t.NO_FIELDS),a=this.value,i=e.scale,o=e.values?e.values.length:e.count,l=e.format||f(i,o,e.formatSpecifier),c=e.values?u(i,e.values):s(i,o);return a&&(r.rem=a),a=c.map(function(e){return n.ingest({value:e,label:l(e)})}),e.extra&&a.push(n.ingest({extra:{value:a[0].value},label:""})),r.source=a,r.add=a,this.value=a,r},t.inherits(h,n.Transform).transform=function(e,r){var a=r.dataflow,i=r.fork(r.NO_SOURCE|r.NO_FIELDS),o=e.item||v,u=e.key||n.tupleid,s=this.value;return s||(r=r.addAll(),this.value=s=t.fastmap().test(g),s.lookup=function(e){return s.get(u(e))}),(e.modified("key")||r.modified(u))&&t.error("DataJoin does not support modified key function or fields."),r.visit(r.ADD,function(e){var n=u(e),t=s.get(n);t?t.exit?(s.empty--,i.add.push(t)):i.mod.push(t):(s.set(n,t=o(e)),i.add.push(t)),t.datum=e,t.exit=!1}),r.visit(r.MOD,function(e){var n=u(e),t=s.get(n);t&&(t.datum=e,i.mod.push(t))}),r.visit(r.REM,function(e){var n=u(e),t=s.get(n);e!==t.datum||t.exit||(i.rem.push(t),t.exit=!0,++s.empty)}),r.changed(r.ADD_MOD)&&i.modifies("datum"),e.clean&&s.empty>a.cleanThreshold&&a.runAfter(s.clean),i},t.inherits(y,n.Transform).transform=function(e,n){var r=n.fork(n.ADD_REM),a=e.encoders,i=n.encode;if(t.isArray(i)){if(!r.changed()&&!i.every(function(e){return a[e]}))return n.StopPropagation;i=i[0]}var o="enter"===i,u=a.update||t.falsy,s=a.enter||t.falsy,f=a.exit||t.falsy,l=(i&&!o?a[i]:u)||t.falsy;if(n.changed(n.ADD)&&(n.visit(n.ADD,function(n){s(n,e),u(n,e),l!==t.falsy&&l!==u&&l(n,e)}),r.modifies(s.output),r.modifies(u.output),l!==t.falsy&&l!==u&&r.modifies(l.output)),n.changed(n.REM)&&f!==t.falsy&&(n.visit(n.REM,function(n){f(n,e)}),r.modifies(f.output)),o||l!==t.falsy){var c=n.MOD|(e.modified()?n.REFLOW:0);o?(n.visit(c,function(n){var t=s(n,e);(l(n,e)||t)&&r.mod.push(n)}),r.mod.length&&r.modifies(s.output)):n.visit(c,function(n){l(n,e)&&r.mod.push(n)}),r.mod.length&&r.modifies(l.output)}return r.changed()?r:n.StopPropagation};var ie={};ie[ee]=function(e){var n=e.domain(),r=[n[0]].concat(e.quantiles());return r.max=t.peek(n),r},ie[ne]=function(e){var n=e.domain(),r=n[0],a=t.peek(n),i=e.range().length,o=new Array(i),u=0;for(o[0]=r;++u<i;)o[u]=(u*a-(u-i)*r)/i;return o.max=a,o},ie[te]=function(e){var n=[-1/0].concat(e.domain());return n.max=1/0,n},ie["bin-linear"]=x,ie[re]=x,t.inherits(b,n.Transform).transform=function(e,r){if(null!=this.value&&!e.modified())return r.StopPropagation;var i=r.fork(r.NO_SOURCE|r.NO_FIELDS),o=0,u=this.value,s="gradient"===e.type,l=e.scale,c=null==e.count?5:e.count,d=e.format||f(l,c,e.formatSpecifier),m=e.values||M(l,c,s);if(d=S(l,d),u&&(i.rem=u),s)var p=e.values?l.domain():m,h=a.scaleFraction(l,p[0],t.peek(p));else{var v,g=e.size;t.isFunction(g)?(e.values||0!==l(m[0])||(m=m.slice(1)),v=m.reduce(function(n,t){return Math.max(n,g(t,e))},0)):g=t.constant(v=g||8)}return u=m.map(function(t,r){var a=n.ingest({index:r,label:d(t,r,m),value:t});return s?a.perc=h(t):(a.offset=v,a.size=g(t,e),a.total=Math.round(o),o+=a.size),a}),i.source=u,i.add=u,this.value=u,i};var oe=t.fastmap({line:R,"line-radial":function(e,n,t,r){return R(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},arc:z,"arc-radial":function(e,n,t,r){return z(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},curve:C,"curve-radial":function(e,n,t,r){return C(n*Math.cos(e),n*Math.sin(e),r*Math.cos(t),r*Math.sin(t))},"orthogonal-horizontal":function(e,n,t,r){return"M"+e+","+n+"V"+r+"H"+t},"orthogonal-vertical":function(e,n,t,r){return"M"+e+","+n+"H"+t+"V"+r},"orthogonal-radial":function(e,n,t,r){var a=Math.cos(e),i=Math.sin(e),o=Math.cos(t),u=Math.sin(t);return"M"+n*a+","+n*i+"A"+n+","+n+" 0 0,"+((Math.abs(t-e)>Math.PI?t<=e:t>e)?1:0)+" "+n*o+","+n*u+"L"+r*o+","+r*u},"diagonal-horizontal":function(e,n,t,r){var a=(e+t)/2;return"M"+e+","+n+"C"+a+","+n+" "+a+","+r+" "+t+","+r},"diagonal-vertical":function(e,n,t,r){var a=(n+r)/2;return"M"+e+","+n+"C"+e+","+a+" "+t+","+a+" "+t+","+r},"diagonal-radial":function(e,n,t,r){var a=Math.cos(e),i=Math.sin(e),o=Math.cos(t),u=Math.sin(t),s=(n+r)/2;return"M"+n*a+","+n*i+"C"+s*a+","+s*i+" "+s*o+","+s*u+" "+r*o+","+r*u}});t.inherits(F,n.Transform).transform=function(e,n){var r=e.sourceX||D,a=e.sourceY||T,i=e.targetX||E,o=e.targetY||w,u=e.as||"path",s=e.orient||"vertical",f=e.shape||"line",l=oe.get(f+"-"+s)||oe.get(f);return l||t.error("LinkPath unsupported type: "+e.shape+(e.orient?"-"+e.orient:"")),n.visit(n.SOURCE,function(e){e[u]=l(r(e),a(e),i(e),o(e))}),n.reflow(e.modified()).modifies(u)},t.inherits(q,n.Transform).transform=function(e,n){var r,a,o,u=e.as||["startAngle","endAngle"],s=u[0],f=u[1],l=e.field||t.one,c=e.startAngle||0,d=null!=e.endAngle?e.endAngle:2*Math.PI,m=n.source,p=m.map(l),h=p.length,v=c,g=(d-c)/i.sum(p),y=i.range(h);for(e.sort&&y.sort(function(e,n){return p[e]-p[n]}),r=0;r<h;++r)o=p[y[r]],(a=m[y[r]])[s]=v,a[f]=v+=o*g;return this.value=p,n.reflow(e.modified()).modifies(u)};var ue=5,se=t.toSet(["linear","pow","sqrt"]),fe=t.toSet(["set","modified","clear","type","scheme","schemeExtent","schemeCount","domain","domainMin","domainMid","domainMax","domainRaw","nice","zero","range","rangeStep","round","reverse","interpolate","interpolateGamma"]);t.inherits(L,n.Transform).transform=function(e,n){var r,i=n.dataflow,o=this.value;o&&!e.modified("type")||(this.value=o=a.scale((e.type||"linear").toLowerCase())());for(r in e)fe[r]||(t.isFunction(o[r])?o[r](e[r]):i.warn("Unsupported scale property: "+r));return P(o,e,_(o,e)),n.fork(n.NO_SOURCE|n.NO_FIELDS)},t.inherits(G,n.Transform).transform=function(e,n){var t=e.modified("sort")||n.changed(n.ADD)||n.modified(e.sort.fields)||n.modified("datum");return t&&n.source.sort(e.sort),this.modified(t),n};t.inherits(H,n.Transform).transform=function(e,n){var r,a,i,o,u=e.as||["y0","y1"],s=u[0],f=u[1],l=e.field||t.one,c="center"===e.offset?J:"normalize"===e.offset?V:B;for(a=0,i=(r=W(n.source,e.groupby,e.sort,l)).length,o=r.max;a<i;++a)c(r[a],o,l,s,f);return n.reflow(e.modified()).modifies(u)};var le={type:"LinkPath",metadata:{modifies:!0},params:[{name:"sourceX",type:"field",default:"source.x"},{name:"sourceY",type:"field",default:"source.y"},{name:"targetX",type:"field",default:"target.x"},{name:"targetY",type:"field",default:"target.y"},{name:"orient",type:"enum",default:"vertical",values:["horizontal","vertical","radial"]},{name:"shape",type:"enum",default:"line",values:["line","arc","curve","diagonal","orthogonal"]},{name:"as",type:"string",default:"path"}]},ce={type:"Pie",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"startAngle",type:"number",default:0},{name:"endAngle",type:"number",default:6.283185307179586},{name:"sort",type:"boolean",default:!1},{name:"as",type:"string",array:!0,length:2,default:["startAngle","endAngle"]}]},de={type:"Stack",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"groupby",type:"field",array:!0},{name:"sort",type:"compare"},{name:"offset",type:"enum",default:"zero",values:["zero","center","normalize"]},{name:"as",type:"string",array:!0,length:2,default:["y0","y1"]}]};n.register(le,F),n.register(ce,q),n.register(de,H),n.transform("AxisTicks",p),n.transform("DataJoin",h),n.transform("Encode",y),n.transform("LegendEntries",b),n.transform("Scale",L),n.transform("SortItems",G),e.transform=n.transform,e.definition=n.definition,e.scale=a.scale,e.scheme=a.scheme,Object.defineProperty(e,"__esModule",{value:!0})});