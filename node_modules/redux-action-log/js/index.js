'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

exports.createActionLog = createActionLog;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function createActionLog(options) {
  var _options$snapshotInte = options.snapshotInterval,
      snapshotInterval = _options$snapshotInte === undefined ? 20 : _options$snapshotInte;
  var _options$limit = options.limit,
      limit = _options$limit === undefined ? 200 : _options$limit;


  var store = void 0;
  var chunks = [];
  var skipped = 0;

  function countActionsInChunks() {
    return (chunks.length - 1) * (snapshotInterval || 0) + chunks[chunks.length - 1].actions.length;
  }

  function cull() {
    if (limit == null || snapshotInterval == null) return;
    var extraActionsCount = countActionsInChunks() - limit;
    var firstNecessaryChunk = Math.floor(extraActionsCount / snapshotInterval);
    if (firstNecessaryChunk > 0) {
      chunks.splice(0, firstNecessaryChunk);
      skipped += firstNecessaryChunk * snapshotInterval;
    }
  }

  var enhancer = function enhancer(createStore) {
    return function (reducer, initialState, enhancer) {
      if (store) throw new Error('redux-action-log enhancer can not be re-used');
      store = createStore(reducer, initialState, enhancer);
      var _store = store,
          _dispatch = _store.dispatch;

      chunks.push({
        state: initialState,
        actions: []
      });
      return (0, _extends3.default)({}, store, {
        dispatch: function dispatch(action) {
          var lastChunk = chunks[chunks.length - 1];
          var actionEntry = { action: action, timestamp: Date.now() };
          if (lastChunk.actions.length === snapshotInterval) {
            chunks.push({
              state: store.getState(),
              actions: [actionEntry]
            });
          } else {
            lastChunk.actions.push(actionEntry);
          }
          cull();
          return _dispatch(action);
        }
      });
    };
  };

  return {
    enhancer: enhancer,
    setLimit: function setLimit(n) {
      limit = n;
      cull();
    },
    getLog: function getLog() {
      var _ref;

      return {
        initialState: chunks[0].state,
        skipped: skipped,
        actions: (_ref = []).concat.apply(_ref, (0, _toConsumableArray3.default)(chunks.map(function (c) {
          return c.actions;
        })))
      };
    },
    clear: function clear() {
      skipped += countActionsInChunks();
      chunks = [{
        state: store.getState(),
        actions: []
      }];
    }
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJjcmVhdGVBY3Rpb25Mb2ciLCJvcHRpb25zIiwic25hcHNob3RJbnRlcnZhbCIsImxpbWl0Iiwic3RvcmUiLCJjaHVua3MiLCJza2lwcGVkIiwiY291bnRBY3Rpb25zSW5DaHVua3MiLCJsZW5ndGgiLCJhY3Rpb25zIiwiY3VsbCIsImV4dHJhQWN0aW9uc0NvdW50IiwiZmlyc3ROZWNlc3NhcnlDaHVuayIsIk1hdGgiLCJmbG9vciIsInNwbGljZSIsImVuaGFuY2VyIiwiY3JlYXRlU3RvcmUiLCJyZWR1Y2VyIiwiaW5pdGlhbFN0YXRlIiwiRXJyb3IiLCJkaXNwYXRjaCIsInB1c2giLCJzdGF0ZSIsImFjdGlvbiIsImxhc3RDaHVuayIsImFjdGlvbkVudHJ5IiwidGltZXN0YW1wIiwiRGF0ZSIsIm5vdyIsImdldFN0YXRlIiwic2V0TGltaXQiLCJuIiwiZ2V0TG9nIiwiY29uY2F0IiwibWFwIiwiYyIsImNsZWFyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztRQXVCZ0JBLGUsR0FBQUEsZTs7OztBQUFULFNBQVNBLGVBQVQsQ0FBeUJDLE9BQXpCLEVBQW9EO0FBQUEsOEJBQzNCQSxPQUQyQixDQUNsREMsZ0JBRGtEO0FBQUEsTUFDbERBLGdCQURrRCx5Q0FDakMsRUFEaUM7QUFBQSx1QkFFdkNELE9BRnVDLENBRXBERSxLQUZvRDtBQUFBLE1BRXBEQSxLQUZvRCxrQ0FFOUMsR0FGOEM7OztBQUl6RCxNQUFJQyxjQUFKO0FBQ0EsTUFBSUMsU0FBa0IsRUFBdEI7QUFDQSxNQUFJQyxVQUFVLENBQWQ7O0FBRUEsV0FBU0Msb0JBQVQsR0FBZ0M7QUFDOUIsV0FBTyxDQUFDRixPQUFPRyxNQUFQLEdBQWMsQ0FBZixLQUFtQk4sb0JBQWtCLENBQXJDLElBQ0xHLE9BQU9BLE9BQU9HLE1BQVAsR0FBYyxDQUFyQixFQUF3QkMsT0FBeEIsQ0FBZ0NELE1BRGxDO0FBRUQ7O0FBRUQsV0FBU0UsSUFBVCxHQUFnQjtBQUNkLFFBQUlQLFNBQVMsSUFBVCxJQUFpQkQsb0JBQW9CLElBQXpDLEVBQStDO0FBQy9DLFFBQU1TLG9CQUFvQkoseUJBQXlCSixLQUFuRDtBQUNBLFFBQU1TLHNCQUFzQkMsS0FBS0MsS0FBTCxDQUFXSCxvQkFBa0JULGdCQUE3QixDQUE1QjtBQUNBLFFBQUlVLHNCQUFzQixDQUExQixFQUE2QjtBQUMzQlAsYUFBT1UsTUFBUCxDQUFjLENBQWQsRUFBaUJILG1CQUFqQjtBQUNBTixpQkFBV00sc0JBQW9CVixnQkFBL0I7QUFDRDtBQUNGOztBQUVELE1BQU1jLFdBQVcsU0FBWEEsUUFBVyxDQUFTQyxXQUFULEVBQWdDO0FBQy9DLFdBQU8sVUFBU0MsT0FBVCxFQUE0QkMsWUFBNUIsRUFBK0NILFFBQS9DLEVBQW9FO0FBQ3pFLFVBQUlaLEtBQUosRUFBVyxNQUFNLElBQUlnQixLQUFKLENBQVUsOENBQVYsQ0FBTjtBQUNYaEIsY0FBUWEsWUFBWUMsT0FBWixFQUFxQkMsWUFBckIsRUFBbUNILFFBQW5DLENBQVI7QUFGeUUsbUJBR3REWixLQUhzRDtBQUFBLFVBR2xFaUIsU0FIa0UsVUFHbEVBLFFBSGtFOztBQUl6RWhCLGFBQU9pQixJQUFQLENBQVk7QUFDVkMsZUFBT0osWUFERztBQUVWVixpQkFBUztBQUZDLE9BQVo7QUFJQSx3Q0FDS0wsS0FETDtBQUVFaUIsZ0JBRkYsb0JBRVdHLE1BRlgsRUFFbUI7QUFDZixjQUFNQyxZQUFZcEIsT0FBT0EsT0FBT0csTUFBUCxHQUFjLENBQXJCLENBQWxCO0FBQ0EsY0FBTWtCLGNBQWMsRUFBQ0YsY0FBRCxFQUFTRyxXQUFXQyxLQUFLQyxHQUFMLEVBQXBCLEVBQXBCO0FBQ0EsY0FBSUosVUFBVWhCLE9BQVYsQ0FBa0JELE1BQWxCLEtBQTZCTixnQkFBakMsRUFBbUQ7QUFDakRHLG1CQUFPaUIsSUFBUCxDQUFZO0FBQ1ZDLHFCQUFPbkIsTUFBTTBCLFFBQU4sRUFERztBQUVWckIsdUJBQVMsQ0FBQ2lCLFdBQUQ7QUFGQyxhQUFaO0FBSUQsV0FMRCxNQUtPO0FBQ0xELHNCQUFVaEIsT0FBVixDQUFrQmEsSUFBbEIsQ0FBdUJJLFdBQXZCO0FBQ0Q7QUFDRGhCO0FBQ0EsaUJBQU9XLFVBQVNHLE1BQVQsQ0FBUDtBQUNEO0FBZkg7QUFpQkQsS0F6QkQ7QUEwQkQsR0EzQkQ7O0FBNkJBLFNBQU87QUFDTFIsc0JBREs7QUFFTGUsWUFGSyxvQkFFSUMsQ0FGSixFQUVnQjtBQUNuQjdCLGNBQVE2QixDQUFSO0FBQ0F0QjtBQUNELEtBTEk7QUFNTHVCLFVBTkssb0JBTVM7QUFBQTs7QUFDWixhQUFPO0FBQ0xkLHNCQUFjZCxPQUFPLENBQVAsRUFBVWtCLEtBRG5CO0FBRUxqQix3QkFGSztBQUdMRyxpQkFBUyxZQUFHeUIsTUFBSCw4Q0FBYTdCLE9BQU84QixHQUFQLENBQVc7QUFBQSxpQkFBS0MsRUFBRTNCLE9BQVA7QUFBQSxTQUFYLENBQWI7QUFISixPQUFQO0FBS0QsS0FaSTtBQWFMNEIsU0FiSyxtQkFhRztBQUNOL0IsaUJBQVdDLHNCQUFYO0FBQ0FGLGVBQVMsQ0FBQztBQUNSa0IsZUFBT25CLE1BQU0wQixRQUFOLEVBREM7QUFFUnJCLGlCQUFTO0FBRkQsT0FBRCxDQUFUO0FBSUQ7QUFuQkksR0FBUDtBQXFCRCIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG5cbmV4cG9ydCB0eXBlIFJlY29yZExvZ09wdGlvbnMgPSB7XG4gIGxpbWl0PzogP251bWJlcjtcbiAgc25hcHNob3RJbnRlcnZhbD86ID9udW1iZXI7XG59O1xuXG5leHBvcnQgdHlwZSBMb2cgPSB7XG4gIGluaXRpYWxTdGF0ZTogYW55O1xuICBza2lwcGVkOiBudW1iZXI7XG4gIGFjdGlvbnM6IEFycmF5PEFjdGlvbkVudHJ5Pjtcbn07XG5cbmV4cG9ydCB0eXBlIEFjdGlvbkVudHJ5ID0ge1xuICBhY3Rpb246IGFueTtcbiAgdGltZXN0YW1wOiBudW1iZXI7XG59O1xuXG50eXBlIENodW5rID0ge1xuICBzdGF0ZTogYW55O1xuICBhY3Rpb25zOiBBcnJheTxBY3Rpb25FbnRyeT47XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQWN0aW9uTG9nKG9wdGlvbnM6IFJlY29yZExvZ09wdGlvbnMpIHtcbiAgY29uc3Qge3NuYXBzaG90SW50ZXJ2YWw9MjB9ID0gb3B0aW9ucztcbiAgbGV0IHtsaW1pdD0yMDB9ID0gb3B0aW9ucztcblxuICBsZXQgc3RvcmU7XG4gIGxldCBjaHVua3M6IENodW5rW10gPSBbXTtcbiAgbGV0IHNraXBwZWQgPSAwO1xuXG4gIGZ1bmN0aW9uIGNvdW50QWN0aW9uc0luQ2h1bmtzKCkge1xuICAgIHJldHVybiAoY2h1bmtzLmxlbmd0aC0xKSooc25hcHNob3RJbnRlcnZhbHx8MCkgK1xuICAgICAgY2h1bmtzW2NodW5rcy5sZW5ndGgtMV0uYWN0aW9ucy5sZW5ndGg7XG4gIH1cblxuICBmdW5jdGlvbiBjdWxsKCkge1xuICAgIGlmIChsaW1pdCA9PSBudWxsIHx8IHNuYXBzaG90SW50ZXJ2YWwgPT0gbnVsbCkgcmV0dXJuO1xuICAgIGNvbnN0IGV4dHJhQWN0aW9uc0NvdW50ID0gY291bnRBY3Rpb25zSW5DaHVua3MoKSAtIGxpbWl0O1xuICAgIGNvbnN0IGZpcnN0TmVjZXNzYXJ5Q2h1bmsgPSBNYXRoLmZsb29yKGV4dHJhQWN0aW9uc0NvdW50L3NuYXBzaG90SW50ZXJ2YWwpO1xuICAgIGlmIChmaXJzdE5lY2Vzc2FyeUNodW5rID4gMCkge1xuICAgICAgY2h1bmtzLnNwbGljZSgwLCBmaXJzdE5lY2Vzc2FyeUNodW5rKTtcbiAgICAgIHNraXBwZWQgKz0gZmlyc3ROZWNlc3NhcnlDaHVuaypzbmFwc2hvdEludGVydmFsO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGVuaGFuY2VyID0gZnVuY3Rpb24oY3JlYXRlU3RvcmU6IEZ1bmN0aW9uKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKHJlZHVjZXI6IEZ1bmN0aW9uLCBpbml0aWFsU3RhdGU6IGFueSwgZW5oYW5jZXI/OiBGdW5jdGlvbikge1xuICAgICAgaWYgKHN0b3JlKSB0aHJvdyBuZXcgRXJyb3IoJ3JlZHV4LWFjdGlvbi1sb2cgZW5oYW5jZXIgY2FuIG5vdCBiZSByZS11c2VkJyk7XG4gICAgICBzdG9yZSA9IGNyZWF0ZVN0b3JlKHJlZHVjZXIsIGluaXRpYWxTdGF0ZSwgZW5oYW5jZXIpO1xuICAgICAgY29uc3Qge2Rpc3BhdGNofSA9IHN0b3JlO1xuICAgICAgY2h1bmtzLnB1c2goe1xuICAgICAgICBzdGF0ZTogaW5pdGlhbFN0YXRlLFxuICAgICAgICBhY3Rpb25zOiBbXVxuICAgICAgfSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5zdG9yZSxcbiAgICAgICAgZGlzcGF0Y2goYWN0aW9uKSB7XG4gICAgICAgICAgY29uc3QgbGFzdENodW5rID0gY2h1bmtzW2NodW5rcy5sZW5ndGgtMV07XG4gICAgICAgICAgY29uc3QgYWN0aW9uRW50cnkgPSB7YWN0aW9uLCB0aW1lc3RhbXA6IERhdGUubm93KCl9O1xuICAgICAgICAgIGlmIChsYXN0Q2h1bmsuYWN0aW9ucy5sZW5ndGggPT09IHNuYXBzaG90SW50ZXJ2YWwpIHtcbiAgICAgICAgICAgIGNodW5rcy5wdXNoKHtcbiAgICAgICAgICAgICAgc3RhdGU6IHN0b3JlLmdldFN0YXRlKCksXG4gICAgICAgICAgICAgIGFjdGlvbnM6IFthY3Rpb25FbnRyeV1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsYXN0Q2h1bmsuYWN0aW9ucy5wdXNoKGFjdGlvbkVudHJ5KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY3VsbCgpO1xuICAgICAgICAgIHJldHVybiBkaXNwYXRjaChhY3Rpb24pO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH07XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBlbmhhbmNlcixcbiAgICBzZXRMaW1pdChuOiA/bnVtYmVyKSB7XG4gICAgICBsaW1pdCA9IG47XG4gICAgICBjdWxsKCk7XG4gICAgfSxcbiAgICBnZXRMb2coKTogTG9nIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGluaXRpYWxTdGF0ZTogY2h1bmtzWzBdLnN0YXRlLFxuICAgICAgICBza2lwcGVkLFxuICAgICAgICBhY3Rpb25zOiBbXS5jb25jYXQoLi4uY2h1bmtzLm1hcChjID0+IGMuYWN0aW9ucykpXG4gICAgICB9O1xuICAgIH0sXG4gICAgY2xlYXIoKSB7XG4gICAgICBza2lwcGVkICs9IGNvdW50QWN0aW9uc0luQ2h1bmtzKCk7XG4gICAgICBjaHVua3MgPSBbe1xuICAgICAgICBzdGF0ZTogc3RvcmUuZ2V0U3RhdGUoKSxcbiAgICAgICAgYWN0aW9uczogW11cbiAgICAgIH1dO1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==